Directory structure:
â””â”€â”€ utxostack-rgbplusplus-design/
    â”œâ”€â”€ README.md
    â”œâ”€â”€ LICENSE
    â””â”€â”€ docs/
        â”œâ”€â”€ light-paper-cn.md
        â”œâ”€â”€ light-paper-en.md
        â”œâ”€â”€ lockscript-design-prd-cn.md
        â”œâ”€â”€ lockscript-design-prd-en.md
        â”œâ”€â”€ security-analysis-cn.md
        â”œâ”€â”€ security-analysis-en.md
        â””â”€â”€ assets/

================================================
File: README.md
================================================
# RGBPlusPlus-design

This repository contains the early-stage design documents for the RGB++ protocol, intended for an open discussion. 

Please note that these documents are preliminary and may undergo further modifications. The contents should not be considered as the final standard or implementation.

**Please don't treat these documentation as the final standard or implementation.**

Documents list:

| # | EN | CN |
| -- | -- | -- |
| 00 | [RGB++ Protocol Whitepaper Draft](./docs/light-paper-en.md) | [RGB++ åè®®ç™½çš®ä¹¦è‰æ¡ˆ](./docs/light-paper-cn.md) |
| 01 | [RGB++ Script Standard](./docs/lockscript-design-prd-en.md) | [RGB++ åˆçº¦è§„èŒƒ](./docs/lockscript-design-prd-cn.md) |
| 02 | [CKB Bitcoin SPV Type Script](https://github.com/ckb-cell/ckb-bitcoin-spv-contracts/blob/master/contracts/ckb-bitcoin-spv-type-lock/README.md) | CKB BTC SPV åˆçº¦è®¾è®¡ |
| 03 | [CKB Bitcoin SPV Library Design](https://github.com/ckb-cell/ckb-bitcoin-spv/blob/master/docs/Design.md) | CKB Bitcoin SPV åº“çš„è®¾è®¡ |
| 04 | [RGB++ Security Analysis](./docs/security-analysis-en.md) | [RGB++ å®‰å…¨æ€§åˆ†æ](./docs/security-analysis-cn.md) |


================================================
File: LICENSE
================================================
MIT License

Copyright (c) 2024 CELL Studio

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.


================================================
File: docs/light-paper-cn.md
================================================
# RGB++ Protocol Light Paper (Draft)

*Cipher from CELL Studio & Nervos Foundation*

> Special thanks to [Ajian](https://twitter.com/AurtrianAjian), [cyberorange](https://twitter.com/xcshuan), [Jan](https://twitter.com/busyforking), [Shawn](https://twitter.com/ShawnMelUni), and [DaPangDun](https://twitter.com/DaPangDunCrypto) for feedback and discussion.

# ç®€ä»‹

RGB++ æ˜¯ä¸€ä¸ªåŸºäº RGB çš„æ‰©å±•åè®®ï¼Œåˆ©ç”¨ä¸€æ¬¡æ€§å¯†å°æ¡å’Œå®¢æˆ·ç«¯éªŒè¯æŠ€æœ¯æ¥ç®¡ç†çŠ¶æ€å˜æ›´å’Œäº¤æ˜“éªŒè¯ã€‚å®ƒé€šè¿‡åŒæ„ç»‘å®šå°†æ¯”ç‰¹å¸ UTXO æ˜ å°„åˆ° Nervos CKB çš„ Cell ä¸Šï¼Œå¹¶åˆ©ç”¨ CKB é“¾å’Œ Bitcoin é“¾ä¸Šçš„è„šæœ¬çº¦æŸæ¥éªŒè¯çŠ¶æ€è®¡ç®—çš„æ­£ç¡®æ€§å’Œå˜æ›´æ‰€æœ‰æƒçš„æœ‰æ•ˆæ€§ã€‚RGB++ è§£å†³äº†åŸ RGB åè®®åœ¨å®é™…è½åœ°ä¸­çš„æŠ€æœ¯é—®é¢˜ï¼Œå¹¶æä¾›äº†æ›´å¤šçš„å¯èƒ½æ€§ï¼Œå¦‚åŒºå—é“¾å¢å¼ºçš„å®¢æˆ·ç«¯éªŒè¯ã€äº¤æ˜“æŠ˜å ã€å…±äº«çŠ¶æ€ä¸æ— ä¸»åˆçº¦ã€éäº¤äº’å¼è½¬è´¦ç­‰ã€‚å®ƒä¸ºæ¯”ç‰¹å¸å¸¦æ¥äº†æ— é¡»è·¨é“¾ã€ä¸æŸå¤±å®‰å…¨æ€§çš„å›¾çµå®Œå¤‡åˆçº¦æ‰©å±•å’Œæ€§èƒ½æ‰©å±•ã€‚

### ä¸€æ¬¡æ€§å¯†å°

ä¸€æ¬¡æ€§å¯†å¯†å°çš„æ¦‚å¿µæœ€æ—©ç”±Â [Peter Todd åœ¨ 2016 å¹´](https://petertodd.org/2016/state-machine-consensus-building-blocks)æå‡ºï¼Œå®ƒå…è®¸ä½ å¯¹ä¸€æ¡æ¶ˆæ¯é”ä¸Šä¸€ä¸ªç”µå­å¯†å°æ¡ï¼Œç¡®ä¿è¿™æ¡æ¶ˆæ¯åªèƒ½è¢«ä½¿ç”¨ä¸€æ¬¡ã€‚å…·ä½“æ¥è¯´ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ¯”ç‰¹å¸çš„æœªèŠ±è´¹çš„äº¤æ˜“è¾“å‡ºï¼ˆUTXOï¼‰ä½œä¸ºæ¶ˆæ¯çš„å¯†å°æ¡ï¼Œæ¯”ç‰¹å¸ç³»ç»Ÿçš„å…±è¯†æœºåˆ¶å¯ä»¥ç¡®ä¿è¿™äº› UTXO ä»…èƒ½è¢«æ¶ˆè´¹ä¸€æ¬¡ï¼Œä¹Ÿå³è¿™äº›å¯†å°æ¡ä»…èƒ½è¢«æ‰“å¼€ä¸€æ¬¡ã€‚

RGB åè®®åˆ©ç”¨è¿™ç§åŸºäºæ¯”ç‰¹å¸ UTXO çš„ä¸€æ¬¡æ€§å¯†å°æ¡ï¼Œå°† RGB çŠ¶æ€å˜æ›´ä¸æ¯”ç‰¹å¸ UTXO çš„æ‰€æœ‰æƒå¯¹åº”ã€‚å› æ­¤æ¯”ç‰¹å¸ç³»ç»Ÿç¡®ä¿äº† RGB çš„çŠ¶æ€æ‰€æœ‰æƒï¼Œä»¥åŠå¯ä»¥é€šè¿‡ UTXO å†å²æ¥è¿½æº¯æ‰€æœ‰çš„çŠ¶æ€å˜æ›´ã€‚ä¸€æ¬¡æ€§å¯†å°ä¸º RGB åè®®æä¾›äº†ç”± Bitcoin å…±è¯†ä¿éšœçš„é˜²åŒèŠ±å®‰å…¨å’Œäº¤æ˜“åˆ†æ”¯è¿½æº¯åŠŸèƒ½ã€‚

### å®¢æˆ·ç«¯éªŒè¯

RGB åè®®åŒ…å«çš„ç”¨æˆ·çŠ¶æ€æ— æ³•ç”±æ¯”ç‰¹å¸å…±è¯†ç›´æ¥éªŒè¯ï¼Œç”¨æˆ·å¿…é¡»é€šè¿‡é“¾å¤–è®¡ç®—ç¡®ä¿ RGB çš„çŠ¶æ€å˜æ›´ç¬¦åˆé¢„æœŸã€‚å®¢æˆ·ç«¯éªŒè¯æŠ€æœ¯å…è®¸ç”¨æˆ·åªéœ€è¦éªŒè¯ä¸è‡ªå·±æœ‰å…³çš„ UTXO åˆ†æ”¯å†å²ï¼Œè€Œæ— éœ€å…³å¿ƒä¸è‡ªå·±æ— å…³çš„äº¤æ˜“å†å²ã€‚RGB çš„çŠ¶æ€å®‰å…¨æ€§é€šè¿‡å®¢æˆ·ç«¯éªŒè¯æ–¹å¼ä¿éšœï¼Œä¸ä¾èµ–ä»»ä½•ä¸­å¿ƒåŒ–ç¬¬ä¸‰æ–¹ã€‚

### RGB åè®®çš„é—®é¢˜

å°½ç®¡ RGB åè®®æœ‰éå¸¸å¤šçš„ä¼˜åŠ¿ï¼Œå°¤å…¶å®ƒå¯ä»¥ä¸º Bitcoin æä¾›å‡ ä¹ä¸å¦¥åçš„åˆçº¦æ‰©å±•ï¼Œä½†åœ¨å®é™…åº”ç”¨ä¸­ä¾ç„¶å­˜åœ¨å¤šä¸ªæŠ€æœ¯å’Œäº§å“é—®é¢˜ã€‚

**DA é—®é¢˜**

æ™®é€šç”¨æˆ·å¦‚ä½•ç”Ÿæˆæˆ–è·å–äº¤æ˜“å†å²çš„è¯æ˜ã€‚æ™®é€šç”¨æˆ·ä½¿ç”¨ç®€å•çš„å®¢æˆ·ç«¯äº§å“æ—¶ï¼Œå¹¶æ²¡æœ‰èƒ½åŠ›æˆ–èµ„æºä¿å­˜æ‰€æœ‰çš„å†å²äº¤æ˜“ï¼Œä¹Ÿå› æ­¤éš¾ä»¥å‘äº¤æ˜“å¯¹æ‰‹æ–¹æä¾›äº¤æ˜“è¯æ˜ã€‚

**P2P ç½‘ç»œé—®é¢˜**

RGB äº¤æ˜“ä½œä¸º Bitcoin çš„æ‰©å±•äº¤æ˜“ï¼Œéœ€è¦ä¾èµ–ä¸€ä¸ª P2P ç½‘ç»œè¿›è¡Œä¼ æ’­ã€‚ç”¨æˆ·ä¹‹é—´åœ¨è¿›è¡Œè½¬è´¦äº¤æ˜“æ—¶ï¼Œä¹Ÿéœ€è¦è¿›è¡Œäº¤äº’å¼æ“ä½œï¼Œæ¥æ”¶æ–¹éœ€è¦æä¾›æ”¶æ¡ã€‚è¿™äº›éƒ½ä¾èµ–ä¸€ä¸ªç‹¬ç«‹äº Bitcoin ç½‘ç»œçš„ P2P ç½‘ç»œã€‚

**è™šæ‹Ÿæœºä¸åˆçº¦è¯­è¨€**

RGB åè®®çš„è™šæ‹Ÿæœºç›®å‰ä¸»è¦æ˜¯é‡‡ç”¨äº† AluVMï¼Œä½œä¸ºæ–°çš„è™šæ‹Ÿæœºï¼Œç›®å‰ç¼ºä¹å®Œå–„çš„å¼€å‘å·¥å…·å’Œå®è·µä»£ç ã€‚

**æ— ä¸»åˆçº¦é—®é¢˜**

RGB åè®®ç›®å‰å°šæ— å®Œå–„çš„æ— ä¸»åˆçº¦ï¼ˆå…¬å…±åˆçº¦ï¼‰çš„äº¤äº’æ–¹æ¡ˆã€‚è¿™å¯¼è‡´å¤šæ–¹äº¤äº’éš¾ä»¥å®ç°ã€‚


### RGB++ åŒæ„ç»‘å®š

![binding](./assets/wp-binding.png)

RGB++ é€šè¿‡åŒæ„ç»‘å®šæŠ€æœ¯è§£å†³äº† RGB åè®®é‡åˆ°çš„é—®é¢˜ï¼Œå¹¶èµ‹äºˆäº† RGB æ›´å¤šçš„å¯èƒ½æ€§ã€‚åœ¨ RGB åè®®ä¸­ï¼Œæœ€é‡è¦çš„ä¸¤ä¸ªç»„ä»¶æ˜¯ç”¨æ¥åšæ‰€æœ‰æƒè®¤å®šçš„ UTXO å’Œç”¨æ¥åšçŠ¶æ€ç®¡ç†ä¸ä¸€æ¬¡æ€§å¯†å°çš„ commitmentã€‚RGB++ çš„åŒæ„ç»‘å®šå°†å…¶ä¸­çš„ Bitcoin UTXO ä¸€ä¸€æ˜ å°„åˆ° CKB çš„ Cell ä¸Šã€ä½¿ç”¨ bitcoin utxo lock æ¥å®ç°æ‰€æœ‰æƒåŒæ­¥ï¼Œå¹¶ä½¿ç”¨ cell çš„ data å’Œ type æ¥å®ç°çŠ¶æ€çš„ç»´æŠ¤ã€‚

### åŒºå—é“¾å¢å¼ºå®¢æˆ·ç«¯éªŒè¯

æ‰€æœ‰çš„ RGB++ äº¤æ˜“éƒ½ä¼šåœ¨ BTC å’Œ CKB é“¾ä¸ŠåŒæ­¥å„å‡ºç°ä¸€ç¬”äº¤æ˜“ã€‚å‰è€…ä¸ RGB åè®®çš„äº¤æ˜“å…¼å®¹ï¼Œåè€…åˆ™å–ä»£äº†å®¢æˆ·ç«¯éªŒè¯çš„æµç¨‹ï¼Œç”¨æˆ·åªéœ€è¦æ£€æŸ¥ CKB ä¸Šçš„ç›¸å…³äº¤æ˜“å³å¯éªŒè¯è¿™ç¬” RGB++ äº¤æ˜“çš„çŠ¶æ€è®¡ç®—æ˜¯å¦æ­£ç¡®ã€‚ä½†ç”¨æˆ·ä¹Ÿå¯ä»¥ä¸ä½¿ç”¨ CKB é“¾ä¸Šçš„äº¤æ˜“ä½œä¸ºéªŒè¯ä¾æ®ï¼Œåˆ©ç”¨ UTXO çš„å±€éƒ¨å†å²äº¤æ˜“ä¿¡æ¯ï¼Œç”¨æˆ·å¯ä»¥è„±ç¦» CKB é“¾ç‹¬ç«‹åœ°å¯¹ RGB++ äº¤æ˜“è¿›è¡ŒéªŒè¯ï¼ˆäº¤æ˜“æŠ˜å ç­‰éƒ¨åˆ†åŠŸèƒ½ä»ç„¶éœ€è¦ä¾èµ– CKB çš„å—å¤´å“ˆå¸Œåšé˜²åŒèŠ±éªŒè¯ï¼‰ã€‚

# RGB++ äº¤æ˜“æµç¨‹

![tx-general](./assets/wp-tx-general.png)

### é“¾å¤–è®¡ç®—

- é€‰ä¸­ä¸‹ä¸€æ¬¡è¦ä½¿ç”¨çš„ä¸€æ¬¡æ€§å¯†å°æ¡ï¼Œä¾‹å¦‚ btc_utxo#2
- é“¾å¤–è®¡ç®—å¹¶ç”Ÿæˆä¸€ç¬”å°†è¦å‘é€åˆ° CKB ä¸Šçš„ RGB++ äº¤æ˜“: CKB_TX_B
- é“¾å¤–è®¡ç®— `commitment = hash(CKB_TX_B | btc_utxo#1 | btc_utxo#2)`

### BTC äº¤æ˜“æäº¤

- ç”Ÿæˆå¹¶å‘é€ä¸€ç¬”æ¯”ç‰¹å¸äº¤æ˜“ Bitcoin_TX_A, è¾“å…¥æ¶ˆè€— `btc_utxo#1`ï¼Œè¾“å‡ºé€šè¿‡ OP_RETURN åŠ å…¥ä¸Šé¢çš„ commitment

### CKB äº¤æ˜“æäº¤

- å‘é€ä¸Šè¿° CKB äº¤æ˜“ CKB_TX_B
- ç”¨æˆ·çš„æœ€æ–°çŠ¶æ€ç”± `CKB_TX_B.output.data` ç»´æŠ¤
- ä¸‹ä¸€æ¬¡å˜æ›´çŠ¶æ€éœ€è¦ä½¿ç”¨ `btc_utxo#2`ã€`CKB_TX_B.output`

### é“¾ä¸ŠéªŒè¯

- Bitcoin éªŒè¯ç›¸å…³çš„ utxo åªèƒ½è¢«æŒ‡å®šç”¨æˆ·èŠ±è´¹ä¸€æ¬¡
- CKB ä¸Šå­˜åœ¨ Bitcoin çš„è½»å®¢æˆ·ç«¯ï¼Œå®ƒå¯ä»¥éªŒè¯ Bitcoin ä¸Šçš„ç›¸å…³äº¤æ˜“å­˜åœ¨ Bitcoin é“¾ä¸Š
    - Bitcoin çš„ç›¸å…³äº¤æ˜“ä½œä¸º ckb äº¤æ˜“çš„ witness è¢«æäº¤ä¸Šæ¥ï¼ŒååŠ©éªŒè¯
- CKB è¿›ä¸€æ­¥éªŒè¯è¯¥ btc äº¤æ˜“èŠ±è´¹äº†æ­£ç¡®çš„ utxo
- CKB è¿›ä¸€æ­¥éªŒè¯è¯¥ btc äº¤æ˜“æ‰¿è¯ºäº†æ­£ç¡®çš„ commitment
- CKB éªŒè¯ CKB ä¸Šçš„çŠ¶æ€è½¬ç§»ç¬¦åˆé¢„è®¢çš„åˆçº¦è§„åˆ™

## RGB++ å®¢æˆ·ç«¯

ä¸åŒäº RGB åè®®ï¼ŒRGB++ çš„æ‰€æœ‰äº¤æ˜“éƒ½åœ¨ CKB ä¸Šå¹¶ç”± CKB è„šæœ¬çº¦æŸéªŒè¯ï¼Œå› æ­¤ RGB++ æ— é¡»ç‹¬ç«‹å®¢æˆ·ç«¯ï¼Œç”¨æˆ·åªéœ€è¦è®¿é—® Bitcoin å’Œ CKB è½»å®¢æˆ·ç«¯å³å¯éªŒè¯æ‰€æœ‰äº¤æ˜“ã€‚å…¶ä¸­ CKB è½»å®¢æˆ·ç«¯åŒæ ·ä½¿ç”¨ PoW ç®—æ³•å¯ä»¥å®ç°æœ€è¿‘çš„è‹¥å¹²ä¸ªå—å¤´å³å¯éªŒè¯æ‰€æœ‰å†å²äº¤æ˜“å’ŒçŠ¶æ€ï¼Œè¿›è€Œåˆ©ç”¨åŒæ„ç»‘å®šéªŒè¯ RGB++ çš„æ‰€æœ‰äº¤æ˜“ã€‚

# äº¤æ˜“æŠ˜å 

RGB++ åè®®å°† Bitcoin UTXO ä¸ CKB Cell è¿›è¡ŒåŒæ„ç»‘å®šï¼Œå®ç°äº† CKB Cell éªŒè¯æ”¯æŒçš„å›¾çµå®Œå¤‡ Bitcoin UTXO äº¤æ˜“ã€‚å¦‚æœæˆ‘ä»¬è¿›ä¸€æ­¥åˆ©ç”¨ CKB Cell çš„å¯ç¼–ç¨‹èƒ½åŠ›ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å°†å¤šç¬” CKB äº¤æ˜“ä¸ä¸€ç¬” Bitcoin RGB++ äº¤æ˜“å¯¹åº”ï¼Œè¿™æ ·å°±å¯ä»¥å°†ä½é€Ÿä½ååé‡çš„ Bitcoin é“¾ä½¿ç”¨é«˜æ€§èƒ½çš„ CKB é“¾è¿›è¡Œæ‰©å®¹ã€‚

![tx-fold](./assets/wp-tx-fold.png)

# å…±äº«çŠ¶æ€ä¸æ— ä¸»åˆçº¦

## å…±äº«çŠ¶æ€çš„å¹³åº¸å®ç°

å…±äº«çŠ¶æ€ä¸€ç›´æ˜¯ UTXO ç³»ç»Ÿçš„éš¾é¢˜ï¼Œè¿™é‡Œå…ˆè®¨è®ºä¸€ç§ä¸è€ƒè™‘å¤šäººåŒæ—¶æ›´æ–°å…±äº«çŠ¶æ€çš„å¹³åº¸å®ç°ï¼Œå†è¿›ä¸€æ­¥è®¨è®ºå®é™…ä¼šé‡‡ç”¨çš„å…è®¸å¤šäººåŒæ—¶æ“ä½œå…±äº«çŠ¶æ€çš„è§£å†³æ–¹æ¡ˆã€‚

è€ƒè™‘ CKB ä¸Šå­˜åœ¨ä¸€ä¸ªå…¨å±€çŠ¶æ€çš„ Cellï¼Œç”¨æ¥ç®¡ç†å¤šç”¨æˆ·å…±äº«çš„çŠ¶æ€ã€‚å…¸å‹åœ°ï¼Œå®ƒå¯ä»¥æ˜¯ä¸€ä¸ªç®—æ³•ç¨³å®šå¸çš„è´¨æŠ¼åˆçº¦ï¼Œç”¨æˆ·å°†æ³¢åŠ¨èµ„äº§å­˜å…¥ï¼Œå¹¶è·å¾—ä¸€ä¸ªå­˜æ¬¾è¯æ˜ã€‚å…¨å±€çŠ¶æ€ç”±æ— ä¸»åˆçº¦ç®¡ç†ï¼Œæ‰€è°“æ— ä¸»åˆçº¦æŒ‡çš„æ˜¯ä»»ä½•äººåœ¨æ»¡è¶³åˆçº¦çš„çº¦æŸå‰æä¸‹éƒ½å¯ä»¥å¯¹çŠ¶æ€è¿›è¡Œå˜æ›´ï¼Œè€Œä¸è¦æ±‚æŒ‡å®šçš„æ•°å­—ç­¾åæä¾›æ–¹è¿›è¡Œå˜æ›´ã€‚æ— ä¸»åˆçº¦çš„å®ç°å¯¹åè®®çš„å»ä¸­å¿ƒåŒ–å’ŒæŠ—å®¡æŸ¥æœ‰å†³å®šæ€§çš„ä½œç”¨ã€‚

è¿™é‡Œçš„å¹³åº¸å®ç°æŒ‡çš„æ˜¯ Global-state cell æœ‰è¢«å…¶ä»–ç”¨æˆ·å ç”¨çš„é£é™©ï¼Œè¿™æ · CKB TX å°±ä¼šå› ä¸ºæŒ‡å®šçš„ Global state utxo ä¸å­˜åœ¨è€Œæ— æ³•æˆç«‹ã€‚è€Œ Bitcoin TX éœ€è¦å…ˆäº CKB TX å‘é€å‡ºæ¥ã€å¹¶å°†å…¶è®¡ç®—åˆ° commitment ä¸­ï¼Œå› æ­¤ä¹Ÿæ— æ³•è¿›è¡Œåç»­çš„éªŒè¯ã€‚

## å…±äº«çŠ¶æ€çš„çŠ¶æ€äº‰æŠ¢é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

ä¸ºäº†è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œæˆ‘ä»¬å¼•å…¥äº† Intent Cell ä½œä¸ºä¸­ä»‹ã€‚ç”¨æˆ·å°†è‡ªå·±å¸Œæœ›æ‰§è¡Œçš„åŠ¨ä½œç¡®å®šæ€§åœ°å†™å…¥ Intent Cellï¼Œåè€…åˆ™å¯ä»¥é€šè¿‡ç¬¬ä¸‰æ–¹èšåˆå™¨çš„åä½œä¸å…¨å±€çŠ¶æ€ Cell äº¤äº’ï¼Œæ‰¹é‡å°†å¤šæ–¹çš„ intent è¿›è¡Œè®¡ç®—ï¼Œå¹¶å°†äº¤äº’ç»“æœåˆå¹¶åˆ°æ ‡å‡†çš„ shadow cell ä¸Šã€‚

# éäº¤äº’å¼è½¬è´¦

åŸå§‹ RGB åè®®çš„ä¸€ä¸ªé—®é¢˜æ˜¯æ”¶æ¬¾æ–¹éœ€è¦æä¾›ä¸€ä¸ªè‡ªå·±çš„ live utxo ä½œä¸º invoice æ‰èƒ½å®æ–½è½¬è´¦ï¼Œè¿™ç§æ–¹å¼è¦æ±‚æ”¶æ¬¾æ–¹å¿…é¡»åœ¨çº¿æ‰èƒ½å®Œæˆä¸€ç¬”æ™®é€šçš„äº¤æ˜“ï¼Œå¢åŠ äº†ç”¨æˆ·ç†è§£éš¾åº¦å’Œäº§å“å¤æ‚åº¦ã€‚RGB++ å¯ä»¥åˆ©ç”¨å›¾çµå®Œå¤‡ç¯å¢ƒçš„ä¼˜åŠ¿ï¼Œå°†äº¤äº’è¡Œä¸ºæ”¾ç½®åœ¨ ckb ç¯å¢ƒé‡Œé¢ï¼Œé‡‡ç”¨å‘é€-é¢†å–ä¸¤æ­¥æ“ä½œæ¥å®ç°éäº¤äº’å¼è½¬è´¦é€»è¾‘ã€‚

## å‘é€

ç”¨æˆ· A å‘ç”¨æˆ· B å‘é€èµ„äº§æ—¶ï¼Œåªéœ€è¦è·çŸ¥ B çš„åœ°å€ï¼Œå¹¶åœ¨ RGB++ äº¤æ˜“ä¸­å‘è¯¥åœ°å€è½¬è´¦ï¼Œè€Œä¸éœ€è¦æ”¶æ¬¾äººæä¾› utxo æˆ– invoiceã€‚

![send tx](./assets/wp-send.png)

## é¢†å–

![claim tx](./assets/wp-claim.png)

CKB çš„ lock åˆçº¦æœ‰èƒ½åŠ›éªŒè¯ btc åœ°å€å¯¹åº”çš„æ•°å­—ç­¾åï¼Œå› æ­¤æ¥æ”¶æ–¹å¯ä»¥åœ¨ CKB ä¸Šæ„é€  Tx C æ¥è§£é”å¯¹åº”çš„ CKB Cellï¼Œå¹¶å°†èµ„äº§è½¬ç§»åˆ°è‡ªå·±çš„ utxo#2 ä¸Šã€‚ä»è€Œå®Œæˆäº†éäº¤äº’å¼æ”¶æ¬¾ã€‚

# Coins

RGB++ ä¸Šçš„ fungible èµ„äº§å‘è¡Œéœ€è¦å¯¹åº”çš„æ•°æ®ç»“æ„æ ‡å‡†å’Œä¸€è‡´æ€§éªŒè¯æ ‡å‡†ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ ckb çš„ xudt æ ‡å‡†ä½œä¸ºå®ƒçš„åŒæ„ç»‘å®šåè®®ã€‚

## å‘è¡Œ

RGB++ coins çš„å‘è¡Œæœ‰å¾ˆå¤šç§æ–¹å¼ï¼ŒåŒ…æ‹¬å¹¶ä¸é™äºä¸­å¿ƒåŒ–åˆ†å‘ã€ç©ºæŠ•ã€è®¤è´­ç­‰æ–¹å¼ã€‚ä»£å¸çš„æ€»é‡ä¹Ÿå¯ä»¥é€‰æ‹©ä¸è®¾ä¸Šé™å’Œé¢„è®¾ä¸Šé™ä¸¤ç§ã€‚å¯¹äºé¢„è®¾ä¸Šé™çš„ä»£å¸ï¼Œå¯ä»¥ä½¿ç”¨çŠ¶æ€å…±äº«æ–¹æ¡ˆåœ¨æ¯æ¬¡å‘è¡Œæ—¶éªŒè¯å·²å‘è¡Œæ€»é‡å°äºç­‰äºé¢„è®¾ä¸Šé™ã€‚

## è½¬ç§»

RGB++ coins çš„è½¬ç§»éå¸¸ç®€å•ï¼Œåªéœ€è¦å°†æ”¶æ¬¾æ–¹å’Œæ‰¾é›¶ utxo åˆ†åˆ«å¯¹åº”åˆ° ckb çš„ shadow cell å³å¯ã€‚coins çš„è½¬ç§»ä¹Ÿå¯ä»¥é€šè¿‡äº¤æ˜“æŠ˜å çš„æ–¹å¼åªå‘ç”Ÿåœ¨ CKB ä¸Šï¼Œå¤šç¬”äº¤æ˜“åå†å°†æœ€åç»“æœ commit åˆ° BTC ä¸Šã€‚

## éšç§

xudt æ˜¯ä¸€ä¸ªé€æ˜çš„ä»£å¸åè®®ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é‡‡ç”¨æ”¯æŒé‡‘é¢éšç§å’Œæµå‘éšç§çš„ä»£å¸åè®®æ¥å¼ºåŒ– RGB++ coins çš„éšç§ä¿æŠ¤ç‰¹æ€§ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ bulletproof ç®—æ³•ï¼Œå°† data ä¸­çš„å†…å®¹å˜æˆç›²åŒ–é‡‘é¢ï¼Œå¹¶åœ¨æ¯æ¬¡è½¬è®©çš„äº¤æ˜“ä¸­æä¾›é‡‘é¢ä¸€è‡´ä¸”éè´Ÿçš„é›¶çŸ¥è¯†è¯æ˜ã€‚è¿™æ ·ï¼Œåªæœ‰äº¤æ˜“å½“äº‹äººçŸ¥é“å½“å‰äº¤æ˜“çš„å…·ä½“é‡‘é¢ä¿¡æ¯ï¼Œç¬¬ä¸‰æ–¹è§‚å¯Ÿè€…æ— æ³•è·çŸ¥é‡‘é¢æ•°æ®ã€‚

æ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨ç¯ç­¾åå®ç°è½¬è´¦æµå‘çš„ç›²åŒ–ã€‚ç”¨æˆ·çš„ coin åœ¨ CKB ä¸Šè½¬è´¦ç»™ç¯ç­¾åæ··æ·†å™¨ï¼Œç„¶åå†å›æµåˆ°ç”± bitcoin utxo ç®¡ç†çš„åœ°å€ä¸Šã€‚é€šè¿‡è¿™ç§æ–¹å¼åˆ‡æ–­èµ„é‡‘æµçš„å†å²è½¨è¿¹ï¼Œä»è€Œå®Œæˆåœ°å€çš„éšç§ä¿æŠ¤ã€‚

# NFTs

## å‘è¡Œ

RGB++ çš„ NFT èµ„äº§å‘è¡Œä¹Ÿå¯ä»¥åˆ©ç”¨åˆ° ckb ä¸Šç°æœ‰çš„ NFT åè®®ï¼ŒåŒ…æ‹¬ä¸é™äº Sporeã€mNFT å’Œ CoTA åè®®ã€‚ä»¥ Spore ä¸ºä¾‹ï¼Œå®ƒå°†æ‰€æœ‰çš„å…ƒæ•°æ®å‡ä¿ç•™çš„é“¾ä¸Šï¼Œå®ç°äº†æ•°æ®å¯ç”¨æ€§çš„ 100% å®‰å…¨ã€‚è€Œ CoTA åè®®åˆ™æ˜¯åˆ©ç”¨çŠ¶æ€å‹ç¼©æŠ€æœ¯ï¼Œå°† NFT ä¿¡æ¯å’ŒæŒæœ‰æ•°æ®å‹ç¼©åœ¨ 32 å­—èŠ‚çš„çš„ SMT ä¸­ï¼Œæä¾›äº†æè‡´çš„æˆæœ¬ä¼˜åŠ¿ã€‚

## è½¬ç§»

RGB++ ä¸­ NFT çš„è½¬è®©ä¹Ÿéå¸¸ç®€å•ï¼Œç±»ä¼¼æ— é¡»æ‰¾é›¶çš„ coins è½¬è´¦ã€‚

![transfer](./assets/wp-transfer.png)

# é—ªç”µç½‘ç»œè”é€š

RGB ä½œä¸ºå®¢æˆ·ç«¯éªŒè¯åè®®å¤©ç„¶æ”¯æŒçŠ¶æ€é€šé“å’Œé—ªç”µç½‘ç»œï¼Œä½†å—é™äº Bitcoin çš„è„šæœ¬è®¡ç®—èƒ½åŠ›ï¼Œåœ¨ Bitcoin ä¸Šå®ç°é btc çš„é—ªç”µç½‘ç»œéå¸¸å›°éš¾ã€‚é€šè¿‡ RGB++ åè®®çš„åŒ…è£¹ï¼Œæˆ‘ä»¬å¯ä»¥åŸºäº CKB çš„å›¾çµå®Œå¤‡è„šæœ¬ç³»ç»Ÿå®ç° RGB++ èµ„äº§çš„çŠ¶æ€é€šé“ä»¥åŠé—ªç”µç½‘ç»œã€‚è¿™é¡¹æŠ€æœ¯æœ‰ç€å·¨å¤§çš„å•†ä¸šå‰æ™¯ï¼Œä¾‹å¦‚åŸºäºé—ªç”µç½‘ç»œçš„ç¨³å®šå¸æ”¯ä»˜ç³»ç»Ÿå¯ä»¥æä¾›ä½äºä¸­å¿ƒåŒ–ç³»ç»Ÿçš„æˆæœ¬å’Œæ€§èƒ½ä¼˜åŠ¿ï¼ŒåŒæ—¶ä¿éšœäº†å»ä¸­å¿ƒåŒ–å’ŒæŠ—å®¡æŸ¥ç‰¹æ€§ã€‚

# åº”ç”¨ä¸¾ä¾‹

## Airdrop

ç»™å®šä¸€ä¸ªåœ°å€åˆ—è¡¨å’Œé‡‘é¢åˆ—è¡¨ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ RGB++ å®ç°å®Œæ•´çš„ airdrop åº”ç”¨ã€‚æˆ‘ä»¬å‡è®¾å¾…é¢†ç©ºæŠ•æ•°æ®å’Œå·²é¢†åœ°å€åˆ—è¡¨å‡ä»¥ SMT çš„ä¿¡æ¯ä¿å­˜åœ¨ cell data ä¸­ã€‚ç”¨æˆ·å³å¯é€šè¿‡è‡ªå·±çš„åœ°å€é¢†å–ç©ºæŠ•ã€‚

## DEX & AMM

RGB++ åˆ©ç”¨ UTXO ç»“æ„å¯ä»¥ç›´æ¥æ”¯æŒåŸºäº UTXO çš„èµ„äº§äº¤æ¢åè®®ï¼Œæ— é¡»å¼•å…¥ä¸­ä»‹æ–¹ã€‚åŒæ—¶åˆ©ç”¨ç½‘æ ¼è®¢å•ç°¿è®¾è®¡å¯ä»¥å®ç°è‡ªåŠ¨åŒ–åšå¸‚å•†æ¨¡å¼ï¼Œæœ‰åˆ«äº Uniswap çš„ä»·æ ¼æ›²çº¿åšå¸‚å•†æ¨¡å¼ï¼Œ**ç½‘æ ¼åšå¸‚å•†æ¨¡å¼**å¯å®šåˆ¶åŒ–æ›´å¼ºï¼Œæ›´é€‚åˆ UTXO ç»“æ„çš„èµ„äº§äº¤æ˜“ã€‚

![dex](./assets/wp-dex.png)

ä¸Šé¢çš„ä¾‹å­æ˜¯å–å®¶æŒ‚å• RGB++ xudtï¼Œä¹°å®¶ä½¿ç”¨ Bitcoin è´­ä¹°ã€‚äº¤æ˜“ç»“æ„ä¸ºä¹°å®¶æä¾›åŒ…å«äº†è¶³å¤Ÿæ•°é‡ Bitcoin çš„ buyerâ€™s utxo å¹¶æä¾› PBST ç­¾åï¼Œä¹°å®¶åˆ™æ„é€  CKB ä¸Šçš„äº¤æ˜“æ¥ç¬¦åˆå–å®¶çš„è¦æ±‚ï¼Œæœ€ç»ˆä¹°å®¶å°†æ„é€ å¥½çš„ CKB äº¤æ˜“å‘é€ç»™å–å®¶ï¼Œå–å®¶å°† BTC äº¤æ˜“å’Œ CKB äº¤æ˜“å…ˆåä¸Šé“¾å®Œæˆäº¤æ˜“ã€‚

# æ€»ç»“

RGB++ ç»§æ‰¿äº† RGB åè®®çš„æ ¸å¿ƒæ€æƒ³ï¼Œé‡‡ç”¨äº†ä¸åŒçš„è™šæ‹Ÿæœºå’ŒéªŒè¯æ–¹æ¡ˆï¼Œç”¨æˆ·æ— é¡»ç‹¬ç«‹çš„ RGB++ å®¢æˆ·ç«¯ï¼Œåªéœ€è¦è®¿é—® Bitcoin å’Œ CKB è½»èŠ‚ç‚¹å³å¯ç‹¬ç«‹å®Œæˆæ‰€æœ‰çš„éªŒè¯ã€‚RGB++ ä¸º Bitcoin å¸¦æ¥äº†å›¾çµå®Œå¤‡åˆçº¦æ‰©å±•å’Œæ•°åå€çš„æ€§èƒ½æ‰©å±•ã€‚å®ƒæ²¡æœ‰ä½¿ç”¨ä»»ä½•è·¨é“¾æ¡¥ï¼Œè€Œæ˜¯ä½¿ç”¨äº†åŸç”Ÿçš„å®¢æˆ·ç«¯éªŒè¯æ–¹æ¡ˆï¼Œç¡®ä¿äº†å®‰å…¨æ€§å’ŒæŠ—å®¡æŸ¥æ€§ã€‚

================================================
File: docs/light-paper-en.md
================================================
# RGB++ Protocol Light Paper (Draft)

*Cipher from CELL Studio & Nervos Foundation*

> Special thanks to [Ajian](https://twitter.com/AurtrianAjian), [cyberorange](https://twitter.com/xcshuan), [Jan](https://twitter.com/busyforking), [Shawn](https://twitter.com/ShawnMelUni), and [DaPangDun](https://twitter.com/DaPangDunCrypto) for feedback and discussion.


# **Introduction**

RGB++ is an extended RGB protocol by using single-use seals and client-side validation techniques to manage state changes and transaction verification. It maps the UTXO set of Bitcoin to the Cell of Nervos CKB via isomorphic bindings, and leverages scripting constraints on both CKB and Bitcoin chains to ensure the correctness of the state computations and the validity of the change ownership.

Addressing technical challenges encountered in the implementation of the original RGB protocol, RGB++ brings a wide array of new possibilities including client-side validation, transaction folding, shared state across contracts, non-interactive transfers, and more. It introduces Turing-complete smart contract scalability and performance to Bitcoin without the need for cross-chain transactions and without compromising security. 

### **Single-Use Seals**

The concept of **single-use seals** was [first introduced by Peter Todd in July, 2016](https://petertodd.org/2016/state-machine-consensus-building-blocks). It allows for a lock of an electronic seal on a message, ensuring that the message can only be used once. Specifically,  Bitcoinâ€™s Unspent Transaction Outputs (UTXOs) can server as seals for messages, and the Bitcoin systemâ€™s consensus mechanism ensures that these UTXOs can only be spent once, meaning that these seals can only be opened once.

The RGB protocol uses single-use seals, which is based on Bitcoin UTXOs, to map RGB state changes to Bitcoin UTXOs ownership. This allows the Bitcoin system to guarantee ownership of the RGB state, as well as traceability of all state changes through the UTXO history. With single-use seals, the RGB protocol inherits Bitcoin's double spending protection and transaction traceability, both enforced by Bitcoin's consensus mechanism. 

### **Client-side Validation**

The RGB protocol contains user state that cannot be directly verified by the Bitcoin consensus. This requires users to utilize off-chain computation to validate that RGB state changes meet expectations. Client-side validation enables users to only validate the relevant UTXO branch history, rather than irrelevant ones. RGB â€˜s state security is provided through client-side validation without reliance on any centralized third party.

### **Problems with the RGB Protocol**

While the RGB protocol has many advantages, especially in providing Bitcoin with virtually uncompromising contract extensions, there are several technical and product issues in practice.

**DA Issues**

**DA(Decentralized Authentication)** refers to whether the average user can generate or obtain proof of transaction history. When using a simple client-side product, average users lack the ability or resources to store full historical transaction data, making it difficult to provide cryptographic proof of transactions to counterparties.

**P2P Network Issues**

As an extension of Bitcoin, RGB transactions rely on a P2P network for propagation.  Users also need to interact with each other when transferring money, for example, recipients need to provide receipts. This introduces dependencies on a P2P network that is independent of the Bitcoin network.

**Virtual Machines and Contract Languages Immaturity**

The RGB protocol currently uses AluVM as its primary virtual machine. As a new model, AluVM lacks mature development tools and code examples for practice.

**Problems of Shared States and Unhosted Contracts**

The RGB protocol presently lacks sophisticated solution for the interaction of unhosted contracts, which limits multi-party interactions to realize.

### **RGB++ isomorphic bindings**

![binding](./assets/wp-binding.png)

RGB++ uses isomorphic bindings to solve the problems encountered by the RGB protocol and unlock more possibilities. In RGB, the two most important components are UTXOs, determining ownership, while commitments manage state and single-use seals. In contrast, RGB++ leverages isomorphic bindings to map Bitcoin UTXOs to Nervos' Cell, ensuring ownership synchronization through the utilization of Bitcoin's UTXO locking scripts. Meanwhile, the state maintenance is managed by the data and type fields of Nervos Cells.

### **Blockchain Enhanced Client-side Validation**

All RGB++ transactions undergo synchronization, resulting in one transaction on both the BTC and CKB chains. The former is compatible with RGB protocol transactions, while the latter serves to replace the client-side validation process. Users only need to check the corresponding transaction on CKB to verify whether the state of the RGB++ transaction is correct.

Also, users also have the option not to use the transactions on the CKB chain as the basis for verifications. By utilizing the local historical transaction information of UTXO, users can independently verify the RGB++ transaction from the CKB chain (note: some functions, such as transaction folding, still need to rely on the block header hash of CKB for anti-double-spending verification).

# **RGB++ Transaction Process**

![tx-general](./assets/wp-tx-general.png)

### **Off-chain Computation**

- Select the next **Single-Use Seals to be used**, e.g. btc_utxo#2;
- Perform off-chain computation to generate an RGB++ transaction (**`CKB_TX_B`**) that will be sent to the CKB;
- Get off-chain calculation: **`commitment = hash(CKB_TX_B | btc_utxo#1 | btc_utxo#2)`**.

### **BTC Transaction Submission**

Generate and broadcast a Bitcoin transaction (**`Bitcoin_TX_A`**), input **`btc_utxo#1`** for consumption,  outputting the above commitment via OP_RETURN.

### CKB Transaction Submission

- Broadcast the CKB transaction (**`CKB_TX_B`**)  mentioned above;
- The user's latest state is maintained by **`CKB_TX_B.output.data`**;
- The next state change requires the use of  **`btc_utxo#2`** and **`CKB_TX_B.output`**;

### **On-chain Validation**

- UTXOs related to Bitcoin validations can only be spent once by a given user;
- A lightweight client on CKB validates the presence of relevant Bitcoin transactions on the Bitcoin chain;
- Bitcoin's related transactions are submitted as witnesses in the CKB transaction for verification;
- CKB then verifies that the BTC transaction spent the correct UTXO;
- CKB further verifies that the BTC transaction commits to the correct commitment;
- CKB verifies that the on-chain state transition complies with the predefined contract rules.

## **RGB++ Client**

In contrast to the RGB protocol, all RGB++ transactions are on CKB and are validated by CKB script constraints. Therefore, RGB++ doesn't require a standalone client; users only need to access Bitcoin and CKB light client to verify all transactions. The CKB light client employs he PoW algorithm to verify all historical transactions and states with just a few recent block headers, which in turn facilitates the use of isomorphic bindings for verifying all RGB++ transactions.

# **Transaction Folding**

The RGB++ protocol uses isomorphic bindings between Bitcoin UTXOs and CKB Cell, enabling the implementation of Turing-complete Bitcoin UTXO transactions validated by CKB Cell.  Specifically, by further leveraging the programmable capabilities of CKB Cells, multiple CKB transactions can be corresponded with a single Bitcoin RGB++ transaction. This approach allows the low speed, low throughput Bitcoin chain to  benefit from higher scalability with the high performance CKB chain.

![tx-fold](./assets/wp-tx-fold.png)

# **Shared State and Unhosted Contracts**

## Mediocre Implementation of Shared State

Shared state has always been a challenge in UTXO systems. Here, we will first discuss a mediocre implementation that does not consider simultaneous updates to the shared state by multiple parties. Then, we will delve into a more practical solution that allows multiple parties to operate on the shared state simultaneously.

Consider a global state cell on the CKB that manages the state shared by multiple users. Typically, it could be a staking contract for an algorithmic stablecoin, where users deposit volatile assets and receive a deposit proof. The global state is managed by an unhosted contract, meaning anyone can make changes to the state without requiring specific digital signatures from designated signatories. The implementation of an unhosted contract plays a crucial role in the decentralization and censorship resistance of the protocol.

A mediocre implementation in this context means that there is a risk that the Global state Cell is occupied by another user, causing CKB TX fail because the specified Global state utxo does not exist. As the Bitcoin TX needs to be sent out and computed into the commitment before the CKB TX, subsequent validation becomes impossible.

## **The Issue of State Contentions in Shared States and Solutions**

To address the above problem, we introduce the Intent Cell as an intermediary. Users can deterministically write down actions they wish to execute into the Intent Cell, which can interact with the global state Cell through the collaboration of a third-party aggregator, batch processing multiple partiesâ€™ intent and merging the results of the interaction into a standard shadow cell.

# **Non-Interactive Transfers**

One issue with the RGB protocol is receivers needs to provide a live UTXO as an invoice to initiate a transfer. This requires recipients stay online to complete a transaction, which increases the complexity for both user understanding and products. Instead, RGB++ leverages the Turing-complete environment by placing the interaction behavior in a CKB environment, and providing a two-step approach of send-receive to implement non-interactive transfer.

## **Send**

When user A sends assets to user B, user A only needs to know user B's address - transferring funds to that address in the RGB++ transaction without requiring user B to provide any UTXOs or invoices.

![send tx](./assets/wp-send.png)

## **Receive**

![claim tx](./assets/wp-claim.png)

The CKB lock contract has the ability to validate the digital signature of the BTC address. Therefore, the receiver can formulate a Tx C on CKB to unlock the corresponding CKB Cell and transfer the assets to their own utxo#2. This finalizes the non-interactive collection process.

# Coins

Issuing fungible assets on RGB++ requires corresponding data structure standards and consistency verification standards. We can adopt the  [xUDT standard on CKB](https://talk.nervos.org/t/rfc-extensible-udt/5337) as the isomorphic binding protocol.

## **Issuance**

There are many ways to issue fungible assets on RGB++, including but not limited to centralized distribution, airdrops, and subscriptions. The total supply of tokens can be either uncapped or pre-capped. For pre-capped tokens, a state sharing scheme can be employed during each issuance to validate that the total issued amount remains less than or equal to the preset cap.

## **Transfer**

Transferring RGB++ coins is a straightforward process, involving mapping the recipient and remaining UTXO balances to the shadow cell of CKB. Also, transferring coins can be streamlined exclusively on CKB through transaction foldings. After multiple transactions are completed, the final results will be committed to BTC.

![transfer](./assets/wp-transfer.png)


## Privacy

The xUDT protocol is a transparent token protocol. To enhance the privacy-preserving features of RGB++ coins, we can explore token protocols that offer both amount privacy and flow privacy. For instance, the bulletproof algorithm can be employed to transform the content in data into a blinded amount, with a zero-knowledge proof demonstrating the consistency and non-negativity of the amount in each transfer transaction. This ensures that only the parties involved in a transaction possess knowledge of the specific amount in the transaction, preventing third-party observers from accessing the date of amount.

Additionally, ring signatures can be used to realize the blinding of the transfer flow. The user's coins are transferred to the ring signature obfuscator on CKB and then redirected back to the address managed by the Bitcoin UTXO. This strategy hides the historical trace of capital flow, thereby achieving enhanced privacy protection for the address.

# NFTs

## Issuance

Issuing NFT assets on RGB++ can also utilize existing CKB NFT standards, including but not limited to the [Spore Protocol](https://spore.pro/), mNFT, and [CoTA protocol](https://talk.nervos.org/t/rfc-cota-a-compact-token-aggregator-standard-for-extremely-low-cost-nfts-and-fts/6338). Taking Spore Protocol as an example, it stores all metadata on-chain, achieving 100% security in data availability. The CoTA protocol, on the other hand, is a compact token aggregator standard which compresses NFT information and holds data in 32-byte SMTs, providing ultimate cost advantages.

## **Transfer**

The transfer of NFTs in RGB++ is also very simple, similar to a coins transfer with no change.

# **Lightning Network Connectivity**

RGB, functioning as a client-side authentication protocol, inherently supports state channels and the Lightning Network. However, due to Bitcoin's scripting limitations, it is very challenging to run non-BTC Lightning networks on the Bitcoin blockchain. By adopting the RGB++ protocol, we can leverage CKB's Turing-complete scripting system to implement state channels and Lightning networks specifically for RGB++ assets. Such technology holds significant commercial potential. For example, a stablecoin payment system built on the Lightning Network can deliver cost and performance advantages that surpass those offered by centralized systems while guaranteeing decentralization and censorship resistance.

# **Examples of Applications**

## Airdrop

Given a list of addresses and corresponding amounts, we can implement a complete airdrop application using RGB++. Assuming that both the pending airdrop data and the claimed address list are stored in cell data as SMT, users can easily collect airdrops from their own addresses.

## DEX & AMM

RGB++ optimizes the UTXO structure, facilitating seamless support for UTXO-based asset exchange protocols without the need for intermediaries. Additionally, RGB++ adopts a grid trading design to enhance its Automated Market Maker (AMM) model. In comparison to Uniswap's AMM model, the grid trading model offers enhanced customization and suitability for trading UTXO-based assets.

![dex](./assets/wp-dex.png)

The example above illustrates a scenario where a buyer is executing a purchase using $BTC in response to a seller's pending order for RGB++ xudt. As the transaction structure involves the buyer's utxo, containing sufficient amount of $BTC and a PBST signature, the buyer can creates a CKB transaction that meets the sellerâ€™s requirements. Afterwards, the buyer sends this signed CKB transaction to the seller. The seller then submits the BTC transaction and CKB transaction on-chain, one after the other, to complete the trade.

# **Summary**

RGB++ inherits the core idea of the RGB protocol while adopting a different virtual machine and validation scheme. Users can independently validate transactions by accessing Bitcoin and CKB light nodes, without needing a separate RGB++ client. In general, RGB++ brings Turing-complete contract scalability and achieves over ten times [performance scaling](https://www.ibm.com/docs/en/zos/2.1.0?topic=storage-tape-capacity-performance-scaling) to Bitcoin. Notably, instead of using cross-chain bridges, RGB++ implements native client-side validation for enhanced security and censorship resistance.

================================================
File: docs/lockscript-design-prd-cn.md
================================================
# RGB++ åˆçº¦è§„èŒƒ

Authors: Cipher Wang, JJY

Contributors: CyberOrange, Ian, Jan

# æ¦‚è¿°

## å…³äºåŒæ„ç»‘å®šçš„è¦æ±‚å’Œé™åˆ¶

åŒæ„ç»‘å®šè¦æ±‚ RGB++ äº¤æ˜“å¿…é¡»åœ¨ BTC ä¸Šæäº¤, ç”¨æˆ·é€šè¿‡åœ¨ BTC æäº¤ä¸€æ¬¡æ€§å¯†å°æ¥æè¿°å¯¹ RGB++ cells çš„æ“ä½œã€‚ç”¨æˆ·éœ€è¦å…ˆæ„é€  CKB raw tx ä»¥åŠ RGB++ commitmentï¼Œå†æŠŠ commitment æäº¤åˆ° BTCï¼Œæœ€åå†å°† CKB TX ä¸Šé“¾ã€‚è¿™é‡Œé¢çš„ä¸€äº›çº¦æŸæ¡ä»¶æœ‰ï¼š

- RGB++ Cell çš„ lock ä¸­å¿…é¡»æŒ‡å®šä»£è¡¨æ‰€æœ‰æƒçš„ BTC UTXO ä¿¡æ¯ï¼ˆbtc_tx + indexï¼‰
- ckb_tx ä¸­çš„ RGB++ Cell ä¾èµ– btc_txï¼Œå¦‚æœ btc_tx.commitment å†åŒ…å« ckb_txï¼Œè¿™å°±æ­»é”äº†ï¼Œå› æ­¤ï¼Œ**Commitment åªèƒ½åŒ…å« ckb tx çš„éƒ¨åˆ†ä¿¡æ¯**
    - Commitment åªä¼šåŒ…å«å‰ N ä¸ª Inputs, Outputs
    - Commitment å¿…é¡»è¦†ç›–æ‰€æœ‰ Type ä¸ä¸ºç©ºçš„ Inputs ä»¥åŠ Outputs
    - CKB TX å¯ä»¥åœ¨ N ä¸ª Inputs, Outputs åä½¿ç”¨é¢å¤–çš„ Type ä¸ºç©ºçš„ Inputs, Outputsï¼Œæ„é€ è€…å¯ä»¥åˆ©ç”¨è¿™ä¸ªè§„åˆ™ä¿®æ”¹äº¤æ˜“çš„æ‰‹ç»­è´¹
- Cell åœ¨åˆ›å»ºæ—¶ä¸ä¼šæ‰§è¡Œ Lock è„šæœ¬éªŒè¯ï¼Œå› æ­¤ä»»ä½•äººéƒ½å¯ä»¥åˆ›å»º RGB++ Cell å¹¶ä½¿ç”¨ä»»æ„çš„ BTC UTXO ä½œä¸º Lock argsï¼Œæˆ‘ä»¬æŠŠè¿™ç§äº¤æ˜“ç†è§£æˆè½¬ç§» cell æ‰€æœ‰æƒåˆ° BTC UTXO ä¸Šï¼Œæ­¤ç±»çš„ Cell åœ¨ä½¿ç”¨æ—¶ä¸ä¸Šè¿°é€»è¾‘ä¸€è‡´ã€‚

# åˆçº¦éœ€æ±‚

éœ€è¦å¦‚ä¸‹åˆçº¦ï¼š

- RGBPP_lock ç”¨æ¥å¤„ç†ä¸ RGB++ Cell çš„è§£é”ï¼›
- BTC_TIME_lock æ—¶é—´é”ï¼Œå½“ç”¨æˆ·èµ„äº§ä» L1 leap åˆ° L2 æ—¶å¿…é¡»ä½¿ç”¨è¯¥ Lock é”å®šä¸€å®šåŒºå—æ•°ã€‚

## åˆçº¦çš„ Config Cell

RGBPP_lock / BTC_TIME_lock åˆçº¦éœ€è¦è¯»å–è½»èŠ‚ç‚¹ï¼Œå› æ­¤æˆ‘ä»¬å¿…é¡»ä¿å­˜ç›¸å…³åˆçº¦çš„ type_hashã€‚ç”±äºä¸å¸Œæœ›å¼•å…¥ç¡¬ç¼–ç çš„åˆçº¦ä¾èµ–ï¼Œæˆ‘ä»¬å¼•å…¥ Config Cell çš„æ¦‚å¿µæ¥è§£å†³æ­¤ç±»é…ç½®é—®é¢˜ã€‚


éƒ¨ç½²åˆçº¦æ—¶ï¼Œè¦æ±‚ contract code cell å’Œ config cell åœ¨åŒä¸€ç¬”äº¤æ˜“çš„ outputs å†…å®Œæˆåˆ›å»ºã€‚

```yaml
# BTC_TIME_lock
inputs: any cells
outputs:
  BTC_TIME_lock code cell
  time_lock_config cell
...

# RGBPP_lock
inputs: any cells
outputs:
  RGBPP_lock code cell
  rgb_lock_config cell
...
```
åˆçº¦é€šè¿‡ä»¥ä¸‹æ–¹å¼æ‰¾åˆ° config cell

```yaml
1. load_script æ‰¾åˆ°ç›®å‰çš„ åˆçº¦çš„ type_hash
2. é€šè¿‡ type_hash æ‰¾åˆ° cell dep ç¬¦åˆä¸” out_point.index == 1 çš„ cell deps çš„ index
3. load è¿™ä¸ª cell dep çš„ data å³å¾—åˆ°å…¨å±€é…ç½®
```

```rust
struct RGBPPConfig {
  version: Uint16,
  // Type hash of bitcoin light client
  bitcoin_lc_type_hash: Byte32,
  // Type hash of bitcoin time lock contract
  bitcoin_time_lock_type_hash: Byte32,
}
```
æ¯æ¬¡æ›´æ–°åˆçº¦éƒ½å¿…é¡»å’Œ Config Cell ä¸€èµ·æ›´æ–°ï¼Œå¹¶ä¸”éµå®ˆæ›´æ–°è§„åˆ™ã€‚

## åˆçº¦æ•°æ®ç»“æ„

### RGBPP_lock

```yaml
RGBPP_lock:
  code_hash: 
    RGBPP_lock
  args:
    out_index | %bitcoin_tx%
```

- RGBPP_lock:
    - out_indexï¼šUTXO index, Cell çš„æ‰€æœ‰æƒå±äºè¯¥ UTXO
    - bitcoin_tx: BTC txid

### BTC_TIME_lock

```yaml
BTC_TIME_lock:
  args: lock_script | after | %new_bitcoin_tx%
```

- BTC Time lock:
    - lock_script è§£é”å Cell çš„æ‹¥æœ‰è€…
    - after è¦æ±‚ new_bitcoin_tx è¶…è¿‡ after ä¸ªç¡®è®¤åå¯ä»¥è§£é”

## RGBPP_Lock è§£é”é€»è¾‘

<aside>
ğŸ’¡ ç”¨äº L1 åœ°å€(btc_utxo)æŒæœ‰çš„ RGB++ èµ„äº§ Cell
</aside>

**Cell è§£é”éªŒè¯æµç¨‹**

![uib](./assets/lock-verify.png)

- è§£é”è€…æä¾›åŒ…å« RGB++ commitment çš„ `btc_tx`ï¼š
    - åŒ…å«åœ¨ CKB ä¸Šçš„ BTC è½»å®¢æˆ·ç«¯ä¸­
    - inputs ä¸­åŒ…å«ä¸è¦è§£é”çš„ cell.lock å¯¹åº”çš„ btc utxo inputï¼Œå³  `btc_tx.inputs[i] == previous_bitcoin_tx | out_index`
    - outputs ä¸­æœ‰ä¸”ä»…æœ‰ä¸€ä¸ª OP_RETURNï¼ŒåŒ…å« `commitment`
    - `self.lockargs.%new_bitcoin_tx% = btc_tx`
- è¯¥ `commitment` ä¸ºä»¥ä¸‹å†…å®¹çš„ hashï¼Œç®—æ³•ä¸º `double sha256(â€RGB++â€ | messages)`
  - `version: u16`ï¼Œå¿…é¡»ä¸º 0
  - `inputs_len:u8`
    - è¡¨ç¤º commitments åŒ…å«å‰ n ä¸ª inputs cells
    - å¿…é¡» >= 1
    - æ‰€æœ‰ type ä¸ä¸ºç©ºçš„ input cell å¿…é¡»è¢«åŒ…å«åœ¨ inputs_len ä¸­
  - `outputs_len:u8`
    - è¡¨ç¤º commitments åŒ…å«å‰ n ä¸ª outputs cells
    - å¿…é¡» >= 1
    - æ‰€æœ‰ type ä¸ä¸ºç©ºçš„ output cell å¿…é¡»è¢«åŒ…å«åœ¨ outputs_len ä¸­
  - `CKB_TX.inputs[:inputs_len]`
  - `CKB_TX.outputs_sub[:outputs_len]`, åŒ…å«å…¨éƒ¨æ•°æ®ï¼Œé™¤äº†
    - ä¸åŒ…å« `lockargs.%new_bitcoin_tx% = btc_tx` 
- äº¤æ˜“ä¸­å…¶ä½™èµ„äº§ä»ç„¶è¢« RGB++ Lock ä¿æŠ¤ï¼Œå³æ‰€æœ‰ outputs ä¸­ type ä¸ä¸ºç©ºçš„ cells å¿…é¡»ä½¿ç”¨ä»¥ä¸‹ä¸¤ç§ lock ä¹‹ä¸€
  - RGBPP_lock
  - BTC_TIME_lock
      - è¦æ±‚ `lockargs.after â‰¥ 6`
      - è¦æ±‚ `lockargs.new_bitcoin_tx == btc_tx`

**tips**

- inputs_len / outputs_len å¯ä»¥ç”±æœ€åä¸€ä¸ªæœ‰ type çš„ input / output cell çš„ä½ç½®è®¡ç®—å‡º
- commitment è‡³å°‘åŒ…å«ä¸€ä¸ª input å’Œ output, å³ä½¿æ‰€æœ‰ inputs å’Œ outputs çš„ type éƒ½ä¸ºç©º
- SDK å¯ä»¥ä¿®æ”¹ commitment ä¹‹å¤–çš„ cells è°ƒæ•´æ‰‹ç»­è´¹

## BTC_TIME_lock è§£é”é€»è¾‘

```yaml
lock.args: lock_hash | after | %new_bitcoin_tx%
```

- lock_script ä¸ºè§£é”åéœ€è¦é‡Šæ”¾åˆ°çš„ç›®æ ‡æ¥å—è€…
    - è§£é”äº¤æ˜“ä¸­æ¯ä¸ª BTC_TIME_lock input å¿…é¡»åœ¨ç›¸åŒ index å¯¹åº”ä¸€ä¸ª output
    - output çš„ lock ä¸º lock_script å…¶ä½™å­—æ®µ type, data, capacity éœ€è¦å’Œ input ä¸€è‡´
- after è¦æ±‚ new_bitcoin_tx å·²ç»è¶…è¿‡ after ä¸ªç¡®è®¤
- è§£é”åçš„ cell æŒæœ‰äººçš„ lock ç¬¦åˆ lock_script

# äº¤æ˜“é€»è¾‘

## L1 è½¬è´¦/æ“ä½œ

**å®šä¹‰ï¼šCKB ä¸Šè¾“å…¥è¾“å‡ºçš„èµ„äº§ cellï¼ˆå®šä¹‰ï¼štype â‰  nullï¼‰ å‡ä¸º RGBPP_lock**

```yaml
# BTC_TX
input:
  btc_utxo_1  # =(previous_btc_tx | out_index)
  ...
output:
  OP_RETURN: commitment
  btc_utxo_3  # =(new_bitcoin_tx | out_index)
  btc_utxo_4  # =(new_bitcoin_tx | out_index)

# CKB_TX
input:
  rgb-xudt:
    type:
      code: xudt
      args: <asset-id>
    lock:
      code: RGBPP_lock
      args: btc_utxo_1 = (out_index | previous_btc_tx)

output:
  xudt:
    type: xudt
    lock:
      code: RGBPP_lock
      args: out_index = 1 | %new_bitcoin_tx%

  xudt:
    type: xudt
    lock:
      code: RGBPP_lock
      args: out_index = 2 | %new_bitcoin_tx%
```

## L1 â†’ L2 Leap æ“ä½œ

**å®šä¹‰ï¼šCKB ä¸Šè¾“å…¥çš„èµ„äº§ cell çš„ lock å‡ä¸º RGB lockï¼Œè¾“å‡ºçš„èµ„äº§ cell çš„ lock è‡³å°‘ä¸€ä¸ªæˆ–å…¨éƒ¨ä¸º BTC_TIME_lockï¼Œå…¶ä½™ä¸º RGBPP_lock**

è¿™é‡Œéœ€è¦åœ¨ CKB ä¸Šå¼•å…¥ä¸€ç§æ–°çš„æ—¶é—´é” Lock: **BTC_TIME_lock**

```yaml
# BTC_TX
input:
  btc_utxo_1
  ...
output:
  OP_RETURN: commitment
  btc_utxo_3

# CKB_TX
input:
  rgb_xudt:
    type: xudt
    lock:
      code: RGBPP_lock
      args: out_index | source_tx

output:
  rgb_xudt:
    type: xudt
    lockï¼š
      code: BTC_TIME_lock
      args: lock_script | after | %new_bitcoin_tx%

  rgb_xudt:
    type: xudt
    lock:
      code: RGBPP_lock
      args: out_index=1 | %new_bitcoin_tx%
```

ç­‰åˆ°è¶³å¤Ÿå¤šçš„ BTC åŒºå—ç¡®è®¤åï¼Œå¯ä»¥è§£é” BTC_TIME_lock çš„ cellã€‚

> æ³¨æ„ï¼šæ¯ä¸ª BTC_TIME_lock input å¯¹åº”çš„ output ä¸Šå¿…é¡»å­˜åœ¨å¯¹åº”è§£é”åçš„ cell, é™¤ lock å¤–å…¶ä½™å­—æ®µä¿æŒä¸å˜

```yaml
# CKB_TX
input:
  rgb_xudt:
    type: xudt
    lock:
      code: BTC_TIME_lock
      args: lock_script | 6 | btc_tx

output:
  rgb_xudt:
    type: xudt
    lock:
      lock_script

witness:
  # proof of 6 confirmations after #btx_tx
```

## L2 â†’ L1 Leap æ“ä½œ

**å®šä¹‰ï¼šè¾“å…¥ä¾§æ²¡æœ‰ RGB_lockï¼Œè¾“å‡ºä¾§æœ‰ RGBPP_lock**

```yaml
# CKB TX
input:
  xudt:
    type: xudt
    lock:
      ckb_address1

output:
  xudt:
    type: xudt
    lock:
      ckb_address2

  rgb_xudt:
    type: xudt
    lock:    
      args: btc_utxo
```

# RGB++ èµ„äº§å‘è¡Œ

## çº¯ L1 æ–¹å¼å‘è¡Œ RGB++ èµ„äº§

ä½¿ç”¨ L1 æ–¹å¼å‘è¡Œ RGB++ è¦æ±‚å‘è¡Œäººä½¿ç”¨ bitcoin ä¸Šçš„äº¤æ˜“ï¼Œutxo æˆ–å…¶ä»– id ä½œä¸ºèº«ä»½æ ‡è¯†ç¬¦æ¥å‘è¡Œèµ„äº§ï¼Œè¿™æ ·æ‰å¯ä»¥åšåˆ°æ— é¡» L2 è¾…åŠ©å³å¯å®Œå…¨å®ç° CSVã€‚å…·ä½“å‘è¡Œæ–¹æ¡ˆæœ‰å¤šç§ï¼Œæˆ‘ä»¬è¿™é‡Œåˆ—å‡ºä¸¤ç§ç®€å•æ–¹æ¡ˆã€‚

### ç›´æ¥å‘è¡Œ

å‘è¡Œäººéœ€è¦å…ˆæ„é€ ä¸€ä¸ªä½¿ç”¨ç‰¹å®š BTC UTXO ä½œä¸º RGBPP_lock çš„ issue_cellã€‚è¯¥æ­¥éª¤æ— é¡»ç»è¿‡åŒæ„ç»‘å®šï¼Œåå³å¯ç”¨è¿™ä¸ª cell è¿›è¡Œä¸€æ¬¡æ€§å‘è¡Œã€‚

```yaml
# BTC TX
input:
  btc_utxo#0
  ...
output:
  commitment
  btc_utxo#1
  ...

# CKB TX
input:
  issue_cell:
    RGBPP_lock:
    args: btc_utxo#0
      
output:
  xudt_cell:
    data: amount
    type: 
      code: xudt
      args: hash(RGBPP_lock|btc_utxo#0)
    lock:
      code: RGBPP_lock
      args: btc_utxo#1
```
### åŒºå—åŒºé—´å‘è¡Œ

åŒºå—åŒºé—´å‘è¡Œéœ€è¦å°† xudt çš„å‘è¡Œæ¨¡å¼ä» lock å‘è¡Œæ”¹ä¸º type å‘è¡Œï¼Œå³åˆ›å»ºä¸€ç§æ–°çš„ xudtï¼Œæˆ–æ’ä»¶ï¼Œä½¿å¾—å‘è¡Œçš„ xudt çš„ type.argsï¼Œå³èµ„äº§ id ä¸æ˜¯ lockhashï¼Œè€Œæ˜¯æŸäº› btc é“¾çš„å‚æ•°å³å¯

```yaml
# BTC TX
input:
  btc_utxo#0
  ...
output:
  commitment
  btc_utxo#1
  ...
  
# CKB TX
input:
  issue_cell:
    RGBPP_lock:
      args: btc_utxo#0

output:
  xudt_cell:
    data: amount
    type: 
      code: xudt_modified
      args: 
        hash_of:
          start_block,
          end_block,
          max_per_tx,
          token_name
    lock:
      code: RGBPP_lock
      args: btc_utxo#1
```

ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œåœ¨[start_block, end_block] åŒºé—´å‘èµ·çš„äº¤æ˜“ï¼Œä»»ä½•äººéƒ½å¯ä»¥åœ¨ BTC L1 ä¸Šå®ç°å…¬å¹³å‘å°„å‘è¡Œï¼Œä»¥å¹³ç­‰çš„æœºä¼šè·å¾—ä»£å¸ã€‚

## L2 å‘è¡Œåè·³è½¬åˆ° L1

æ¯”è¾ƒç®€å•ï¼Œä¹Ÿæ›´çµæ´»ï¼Œä¸å†èµ˜è¿°ã€‚


================================================
File: docs/lockscript-design-prd-en.md
================================================
# RGB++ Script Standard

Authors: Cipher Wang, JJY

Contributors: CyberOrange, Ian, Jan

# Overview

## Requirements and Limitations on Isomorphic Binding

Isomorphic Binding requires that RGB++ transactions must be submitted on BTC chain, and that the user use single-use seals on BTC to describe the operation on RGB++ cells. The user needs to construct the CKB raw tx and the RGB++ commitment first, then submit the commitment to BTC, and finally send the CKB TX on-chain. 

However, there are some constraints:

- The BTC UTXO information that represents ownership must be specified in theÂ `lock`Â of the RGB++ Cell (`btc_tx`Â + `index`).
- The RGB++ Cell inÂ `ckb_tx`Â depends onÂ `btc_tx`; ifÂ `btc_tx.commitment`Â includesÂ `ckb_tx`, it results in a deadlock. Thus, **the commitment can only contain these following information of the CKB transaction**:
    - Commitment includes only the first N Inputs and Outputs;
    - Commitment must cover all Inputs and Outputs whereÂ `Type`Â is not null;
    - After the initial N Inputs and Outputs, the CKB transaction can include additional Inputs and Outputs with a nullÂ `Type`. This rule allows for modifications to the transaction fee.
- Cell is created without lock script validation, allowing anyone to create an RGB++ Cell using any BTC UTXO asÂ `LockArgs`. This process essencially transfers ownership of the Cell to a BTC UTXO. Also, the operation of this type of Cell follows the same principles outlined above.

# Contract Requirements

The following contract is required:

- `RGBPP_lock`: this is designed to handle the unlocking process of the RGB++ Cell;
- `BTC_TIME_lock`: this is a time lock used to secure a specified number of blocks when assets leap from Layer 1 (L1) to Layer 2 (L2).

## **Config Cell** of the Contract

Both the `RGBPP_lock` and `BTC_TIME_lock` require the [BTC light client](https://github.com/ckb-cell/ckb-bitcoin-spv-contracts/blob/master/contracts/ckb-bitcoin-spv-type-lock/README.md) data, necessitating the storage of the associated contract's `type_hash`. To avoid hardcoded dependencies, the concept of Config Cell is introduced here to address this configuration issue.

When deploying a contract, both the `contract code cell` and the `config cell` must be included in the same transaction's outputs.

```
# BTC_TIME_lock
inputs: any cells
outputs:
  BTC_TIME_lock code cell
  time_lock_config cell
...

# RGBPP_lock
inputs: any cells
outputs:
  RGBPP_lock code cell
  rgb_lock_config cell
...
```

The contract follows these steps to identify Config Cell:

```
1. UseÂ load_scriptÂ to retrieve theÂ type_hashÂ of the current contract;
2. UseÂ type_hashÂ to identify the index that its cell dep matches and hasÂ out_point.index == 1;
3. Load the data from this cell dep to fetch global configuration settings.
```

```
struct RGBPPConfig {
  version: Uint16,
  // Type hash of bitcoin light client
  bitcoin_lc_type_hash: Byte32,
  // Type hash of bitcoin time lock contract
  bitcoin_time_lock_type_hash: Byte32,
}
```

Whenever the contract is updated, the Config Cell must be updated as well, and these updates must adhere to predefined rules.

## Data Structure of the Contract

### **RGBPP_lock**

```
RGBPP_lock:
  code_hash:
    RGBPP_lock
  args:
    out_index | %bitcoin_tx%
```

- `RGBPP_lock`:
    - out_index: UTXO index, the ownership of the Cell belongs to this UTXO
    - bitcoin_tx: BTC txid

### **BTC_TIME_lock**

```
BTC_TIME_lock:
  args: lock_script | after | %new_bitcoin_tx%
```

- `BTC_TIME_lock`:
    - refers to the owner of Cell once `lock_script` is unlocked;
    - `after` requires that `new_bitcoin_tx` can only be unlocked after it has received more than the number of confirmations specified by theÂ `after` .

## **RGBPP_Lock Unlock Logic**

ğŸ’¡Â For Cell of the RGB++ Asset on L1 Address (`btc_utxo`)

### **Cell Unlock Validation Process**

![uib](./assets/lock-verify.png)

The process for unlocking involves providing a `btc_tx` with the RGB++ commitment:

- It is included within the BTC light client on CKB.
- Inputs should include the BTC UTXO Input corresponding to the cell.lock to be unlocked, i.e.,Â `btc_tx.inputs[i] == previous_bitcoin_tx | out_index`.
- Outputs must contain only one `OP_RETURN`, which includeÂ `commitment`.
- `self.lockargs.%new_bitcoin_tx% = btc_tx`.

The `commitment` is created using theÂ `double sha256("RGB++" | messages)`Â method, and should satisfy the following rules:

- `version: u16`Â should always be 0;
- `inputs_len: u8`:
    - Specifies the commitment includes the first n input cells;
    - Must be >= 1;
    - All input cells with a non-null type must be included withinÂ `inputs_len` ;
- `outputs_len: u8`:
    - Specifies the commitment includes the first n output cells;
    - Must be >= 1;
    - All output cells with a non-null type must be included withinÂ `outputs_len` ;
- `CKB_TX.inputs[:inputs_len]` ;
- `CKB_TX.outputs_sub[:outputs_len]`includes all data except for:
    - `lockargs.%new_bitcoin_tx% = btc_tx` .

The remaining assets in the transaction is secured by the RGB++ Lock. All output cells that have a non-null type must use one of the following locks:

- `RGBPP_lock`
- `BTC_TIME_lock`, which requires:
    - `lockargs.after â‰¥ 6` ;
    - `lockargs.new_bitcoin_tx == btc_tx`.

Tips:

- `inputs_len`Â andÂ `outputs_len`Â can be calculated by the position of the last input or output cell with a `type` ;
- The commitment must include at least one input and one output, even if all input `type` and output `type` are null;
- SDKs can alter cells outside of the commitment to adjust the transaction fee.

## **BTC_TIME_lock Unlock Logic**

```
lock.args: lock_hash | after | %new_bitcoin_tx%
```

- TheÂ `lock_script`Â identifies the recipient who will receive the assets after the lock is unlocked:
    - For each `BTC_TIME_Lock` input in a transaction, there must be a corresponding output at the same index;
    - The lock of the output must beÂ `lock_script`, with the other fields such as `type`, `data`, and `capacity` must be identical to those in the input.
- `after` requires that theÂ `new_bitcoin_tx`Â has more than the number of confirmations specified by theÂ `after` ;
- after unlocking, the `lock` of the cell holder must match theÂ `lock_script`.

# **Transaction Logic**

## **L1 Transfers/Operations**

**Definition**: The locks of `non-null asset type` inputs and outputs in a CKB transaction are all RGBPP_lock.

```
# BTC_TX
input:
  btc_utxo_1  # =(previous_btc_tx | out_index)
  ...
output:
  OP_RETURN: commitment
  btc_utxo_3  # =(new_bitcoin_tx | out_index)
  btc_utxo_4  # =(new_bitcoin_tx | out_index)

# CKB_TX
input:
  rgb-xudt:
    type:
      code: xudt
      args: <asset-id>
    lock:
      code: RGBPP_lock
      args: btc_utxo_1 = (out_index | previous_btc_tx)

output:
  xudt:
    type: xudt
    lock:
      code: RGBPP_lock
      args: out_index = 1 | %new_bitcoin_tx%

  xudt:
    type: xudt
    lock:
      code: RGBPP_lock
      args: out_index = 2 | %new_bitcoin_tx%
```

## L1 â†’ L2 Leap

**Definition**: On CKB, the lock for input asset cell is `RGB_lock`. For output asset cells, at least one, and possibly all, will be `BTC_TIME_lock`; while the remaining output asset cells use `RGBPP_lock`.

`BTC_TIME_lock`, as a new type of timelock on CKB, is introduced here.

```
# BTC_TX
input:
  btc_utxo_1
  ...
output:
  OP_RETURN: commitment
  btc_utxo_3

# CKB_TX
input:
  rgb_xudt:
    type: xudt
    lock:
      code: RGBPP_lock
      args: out_index | source_tx

output:
  rgb_xudt:
    type: xudt
    lockï¼š
      code: BTC_TIME_lock
      args: lock_script | after | %new_bitcoin_tx%

  rgb_xudt:
    type: xudt
    lock:
      code: RGBPP_lock
      args: out_index=1 | %new_bitcoin_tx%
```

After enough BTC blocks have been confirmed, the `BTC_TIME_lock` cells can be unlocked. 

> Note: Each output corresponding to a `BTC_TIME_lock` input must have an unlocked cell where all fields should remain unchanged from the input except for the lock field.
> 

```
# CKB_TX
input:
  rgb_xudt:
    type: xudt
    lock:
      code: BTC_TIME_lock
      args: lock_script | 6 | btc_tx

output:
  rgb_xudt:
    type: xudt
    lock:
      lock_script

witness:
  # proof of 6 confirmations after #btx_tx
```

## **L2 â†’ L1 Leap**

**Definition**: No RGBPP_lock in the transaction Inputs, while Outputs has RGBPP_lock.



```
# CKB TX
input:
  xudt:
    type: xudt
    lock:
      ckb_address1

output:
  xudt:
    type: xudt
    lock:
      ckb_address2

  rgb_xudt:
    type: xudt
    lock:
      args: btc_utxo

```

# **RGB++ Asset Issuance**

## Bitcoin L1 Issuance of RGB++ Assets

To issue RGB++ assets using Bitcoin's Layer 1, the issuer must initiate a bitcoin transaction that uses UTXO or other id as an identifier. This method enables the implementation of CSV on Layer 1, eliminating the need for Layer 2 involvement. There are various issuance methods, the following sections will discuss two primary issuance methods: direct issuance and inter-block issuance.

### **Direct Issuance**

An issuer needs to create a specific UTXO as an issue_cell lock. The issue_cell will then be used for a one-time issuance.

```
# BTC TX
input:
  btc_utxo#0
  ...
output:
  commitment
  btc_utxo#1
  ...

# CKB TX
input:
  issue_cell:
    RGBPP_lock:
    args: btc_utxo#0

output:
  xudt_cell:
    data: amount
    type:
      code: xudt
      args: hash(RGBPP_lock|btc_utxo#0)
    lock:
      code: RGBPP_lock
      args: btc_utxo#1
```

### **Inter-block issuance**

Inter-block issuance involves altering the issuance mode of an extensible User-Defined Token ([xUDT](https://talk.nervos.org/t/rfc-extensible-udt/5337)) from `lock` to `type`. This means that the new xUDT's type.args (a.k.a. asset ID) is not lock_hash but some parameters on the BTC chain.

```
# BTC TX
input:
  btc_utxo#0
  ...
output:
  commitment
  btc_utxo#1
  ...

# CKB TX
input:
  issue_cell:
    RGBPP_lock:
      args: btc_utxo#0

output:
  xudt_cell:
    data: amount
    type:
      code: xudt_modified
      args:
        hash_of:
          start_block,
          end_block,
          max_per_tx,
          token_name
    lock:
      code: RGBPP_lock
      args: btc_utxo#1
```

In the above example, for transactions initiated within the [`start_block, end_block`] interval, anyone can executes a fair launch on BTC L1, ensuring that everyone has equal chance of token distribution.

## **Leap to L1 Following L2 Issuance**

This process is straightforward and offers greater flexibility, hence it will not be discussed in this document.


================================================
File: docs/security-analysis-cn.md
================================================
# RGB++ æ·±å…¥è®¨è®ºï¼šå®‰å…¨æ€§åˆ†æ

*Cipher from CELL Studio & Nervos Foundation*

> Special thanks to [Ren Zhang](https://scholar.google.com/citations?hl=en&user=JB1uRvQAAAAJ), [Ian](https://github.com/doitian), and [c4605](https://talk.nervos.org/u/c4605/summary) for feedback and discussion.
> The RGB receiver optimization approach is inspired by [Jason Cai](https://twitter.com/CryptoStwith).

## **PoW æ¯”ä½ æƒ³è±¡çš„æ›´å®‰å…¨**
PoW çš„å®‰å…¨æ€§é£é™©åœ¨äºåŒºå— revert/reorgï¼Œä»è€Œå¯¼è‡´åŒèŠ±ã€‚åªè¦æœ‰ä¸€ä¸ªè¯šå®çŸ¿å·¥ï¼Œç”¨æˆ·çš„çŠ¶æ€/èµ„äº§å°±ä¸ä¼šè®¡ç®—é”™è¯¯ï¼Œåªæœ‰å¯èƒ½å‡ºç°å› åŒºå—é‡æ•´å¯¼è‡´çš„åŒèŠ±äº¤æ˜“æŸå¤±ã€‚å› æ­¤ PoW çš„æ ¸å¿ƒå®‰å…¨å‡è®¾å°±æ˜¯ N ä¸ªåŒºå—åäº¤æ˜“å°±å‡ ä¹ä¸ä¼šè¢« revert äº†ï¼Œä¾‹å¦‚ Bitcoin æ™®éè®¤ä¸º 6 åŒºå—ç”šè‡³æ›´å°‘å³å¯ã€‚

æ˜¾ç„¶ï¼Œ6ç¡®è®¤çš„ BTC è‚¯å®šæ¯”1ç¡®è®¤æ›´å®‰å…¨ï¼Œé‚£ä¹ˆ PoW ç¡®è®¤æ•°å’Œå®‰å…¨æ€§æ˜¯çº¿æ€§å…³ç³»å—ï¼Ÿå¹¶ä¸æ˜¯ï¼Œ**æ¨ç¿»åŒºå—çš„éš¾åº¦éšç€åŒºå—æ·±åº¦æŒ‡æ•°å¢é•¿**ï¼Œè¿™ä¸ªæŒ‡æ•°å¢é•¿å…·ä½“çš„å‚æ•°å·²ç»æœ‰å‡ åç¯‡è®ºæ–‡åœ¨è®¨è®ºäº†ã€‚éšç€æ—¶é—´çš„æ¨ç§»ï¼Œå¤§å®¶å‘ç°â€œNCæ¯”ä»å‰ä»¥ä¸ºçš„æ›´å®‰å…¨â€ã€‚

æ ¹æ® [Ren Zhang](https://scholar.google.com/citations?hl=en&user=JB1uRvQAAAAJ) åšå£«çš„è®¡ç®—ï¼Œå‡è®¾æ•Œæ‰‹ç®—åŠ›å æ¯”30%ï¼Œè¦å®ç°æ¯”ç‰¹å¸ä¸­å­¤å—ç‡ä¸º0ã€6ä¸ªå—ç¡®è®¤çš„å®‰å…¨æ€§ï¼Œå½“ CKB çš„å­¤å—ç‡è®¾å®šæˆ 2.5% çš„æ—¶å€™ï¼Œéœ€è¦23.29ä¸ªå—ç¡®è®¤å³å¯è¾¾åˆ°ç›¸åŒçš„å®‰å…¨æ€§ ã€‚é€šè¿‡è¿™æ ·çš„ç­‰ä»·å…³ç³»ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨åç»­çš„è®¨è®ºä¸­æ–¹ä¾¿åœ°è®¨è®º RGB++ åè®®ä¸­å„ç§å…¸å‹æ“ä½œçš„å®‰å…¨æ€§ã€‚

![pow](./assets/sa-pow.png)
***PoW å®‰å…¨æ€§çš„ç¤ºæ„å›¾ï¼ˆéç†è®ºè®¡ç®—ï¼‰***

## **RGB çš„å®‰å…¨æ€§**
RGB é€šè¿‡ä¸€æ¬¡æ€§å¯†å°å’Œå®¢æˆ·ç«¯éªŒè¯çš„æ–¹å¼å®ç°äº†åœ¨ Bitcoin UTXO ä¸Šç»‘å®š RGB çš„çŠ¶æ€å’Œåˆçº¦ï¼Œä¸º Bitcoin æä¾›äº†å›¾çµå®Œå¤‡çš„æ‰©å±•ã€‚äº¤æ˜“å®‰å…¨æ€§æœ‰ä¸¤ç±»ï¼Œä¸€ç±»æ˜¯çŠ¶æ€è®¡ç®—çš„æ­£ç¡®æ€§ï¼›ä¸€ç±»æ˜¯äº¤æ˜“ç¡®å®šæ€§ï¼Œå³åŒèŠ±é£é™©ã€‚å®¢æˆ·ç«¯éªŒè¯ç¡®ä¿äº†çŠ¶æ€è®¡ç®—çš„æ­£ç¡®æ€§ï¼Œæ¯ä¸ªäººè´Ÿè´£è‡ªå·±çš„çŠ¶æ€ï¼Œä¸ä¾èµ–ä»»ä½•ç¬¬ä¸‰æ–¹ã€‚è€ŒåŸºäº BTC UTXO çš„ä¸€æ¬¡æ€§å¯†å°ç¡®ä¿äº†åŒèŠ± RGB çš„éš¾åº¦å’ŒåŒèŠ± BTC çš„éš¾åº¦ç›¸åŒã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥è¯´** RGB 100% ç»§æ‰¿äº† Bitcoin çš„å®‰å…¨æ€§**ã€‚ç”¨æˆ·éœ€è¦å¤šå®‰å…¨ï¼Œå°±æŒ‰ç…§æ¯”ä¾‹ç­‰å¾…å¤šå°‘ä¸ª BTC ç¡®è®¤å³å¯ã€‚

## **RGB++ çš„å®‰å…¨æ€§**
### **L1 äº¤æ˜“å®‰å…¨æ€§**
RGB++ çš„ L1 äº¤æ˜“æŒ‡çš„æ˜¯ RGB++ äº¤æ˜“çš„ UTXO çš„"æŒæœ‰äºº" æ˜¯ Bitcoin çš„ UTXOã€‚å³åªæœ‰æ¶ˆè´¹ Bitcoin UTXO æ‰èƒ½æ“ä½œæˆ–æ›´æ–° RGB++ UTXOã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œè™½ç„¶æ¯ä¸€ç¬” RGB++ äº¤æ˜“éƒ½åŒæ­¥å‘èµ·ä¸€ç¬” CKB äº¤æ˜“ï¼Œä½†å…¶å®‰å…¨æ€§å’Œ CKB æ²¡æœ‰å…³ç³»ï¼ŒCKB ä»…ä½œä¸º DA å’ŒçŠ¶æ€å…¬ç¤ºæ¥ä½¿ç”¨ã€‚**è¿™ç§æƒ…å†µä¸‹ï¼ŒRGB++ L1 çš„äº¤æ˜“å®‰å…¨æ€§å’Œ RGB äº¤æ˜“ç›¸åŒï¼Œä¹Ÿæ˜¯å®Œå…¨ç»§æ‰¿äº† BTC çš„å®‰å…¨æ€§ã€‚**

### **L2 äº¤æ˜“å®‰å…¨æ€§**
L2 äº¤æ˜“å³ 100% å‘ç”Ÿåœ¨ CKB ä¸Šçš„äº¤æ˜“ï¼Œæ˜¾ç„¶å®ƒçš„å®‰å…¨æ€§ 100% ç”± CKB è´Ÿè´£ã€‚ä½†ç”±äºå¼€ç¯‡æå‡ºçš„ PoW å®‰å…¨çš„éçº¿æ€§ç‰¹æ€§ï¼Œ24ä¸ªåŒºå—çš„ ckb ç¡®è®¤å³å¯ç­‰ä»·äº 6 ç¡®è®¤çš„ BTC ç¡®è®¤ï¼Œå› æ­¤æˆ‘ä»¬ä¹Ÿå¯ä»¥è¯´ L2 äº¤æ˜“å®‰å…¨æ€§ä¸ L1 äº¤æ˜“å®‰å…¨æ€§ç­‰ä»·ï¼ˆéœ€è¦æ›´å¤šåŒºå—ç¡®è®¤ï¼Œä½†äº‹å®ä¸Šæ›´çŸ­ç¡®è®¤æ—¶é—´ï¼‰ã€‚

èƒ½åšåˆ°è¿™ä¸€ç‚¹çš„å‰ææ˜¯ RGB++ çš„åŒæ„æ˜ å°„é“¾å¿…é¡»æ˜¯ PoW çš„ï¼Œå¦‚æœå®ƒæ˜¯ PoS çš„é“¾ï¼Œæ— è®ºç­‰å¾…å¤šå°‘ä¸ªåŒºå—ï¼Œå®ƒå®‰å…¨æ€§ä¸Šé™éƒ½æ˜¯ PoS çš„ stake é‡ï¼Œæ— æ³•ä¸ Bitcoin å®‰å…¨æ€§ç­‰ä»·ã€‚

### **JUMP æ“ä½œ**
RGB++ åè®®ä¸­ç”¨æˆ·çš„èµ„äº§æ—¢å¯ä»¥åœ¨ Bitcoin ä¸Šæµè½¬ï¼Œä¹Ÿå¯ä»¥éšæ—¶åˆ° CKB ä¸Šæµè½¬ï¼Œæˆ–è€…åå‘æ“ä½œã€‚åœ¨åˆ‡æ¢çš„è¿‡ç¨‹ä¸éœ€è¦è·¨é“¾æ¡¥ï¼Œæ›´ä¸éœ€è¦ä¿¡ä»»ä»»ä½•å¤šç­¾æ–¹ã€‚æˆ‘ä»¬å°†èµ„äº§æˆ–çŠ¶æ€åœ¨ Bitcoin ä¸Šå’Œ CKB ä¸Šæµè½¬çš„åˆ‡æ¢ç§°ä¸º Jumpã€‚Jump æ“ä½œå‰åï¼Œå½±å“ RBG++ åè®®å®‰å…¨æ€§çš„æ ¸å¿ƒç‚¹åœ¨äºï¼š

- ä¸€æ¬¡æ€§å¯†å°æ¡ï¼Œä»ä½¿ç”¨ Bitcoin UTXO å˜ä¸ºä½¿ç”¨ CKB UTXOï¼Œæˆ–ç›¸å

- å®¢æˆ·ç«¯éªŒè¯æ‰€éœ€è¦çš„æ•°æ®ä¿æŒä¸å˜ï¼Œéƒ½æ˜¯ CKB ä¸Šçš„åŒæ„ç»‘å®šäº¤æ˜“

Jump æ“ä½œæ—¶ï¼Œç”¨æˆ·éœ€è¦åœ¨ä¸¤æ¡é“¾ä¸Šåˆ†åˆ«ç­‰å¾…è¶³å¤Ÿçš„åŒºå—æ•°ï¼Œä»¥è·å¾—å®‰å…¨æ€§ã€‚

## **å…¼é¡¾ç”¨æˆ·ä½“éªŒ**
æ ¹æ®ä¸Šé¢çš„è®¨è®ºï¼Œç­‰å¾…è¶³å¤Ÿå¤šçš„åŒºå—æ•°ç¡®å®å¯ä»¥è·å¾—è¶³å¤Ÿçš„å®‰å…¨æ€§ï¼Œä½†ç”¨æˆ·ä½“éªŒå®åœ¨å¤ªå·®äº†ã€‚è€ƒè™‘å¹³åº¸çš„æ–¹æ¡ˆï¼Œæ¯ä¸ª RGB++ L1 äº¤æ˜“è¦ç­‰å¾… 6 ä¸ª BTC ç¡®è®¤å†è¿›è¡Œä¸‹ä¸€æ¬¡æ“ä½œï¼Œæ¯ä¸ª L2 äº¤æ˜“è¦ç­‰å¾… 24 ä¸ª CKB ç¡®è®¤å†è¿›è¡Œä¸‹ä¸€æ¬¡æ“ä½œï¼Œè€Œ Jump æ“ä½œåˆ™éœ€è¦ç­‰å¾… 6 BTC + 24 CKB ç¡®è®¤ã€‚èƒ½å¦å¯¹è¿™ä¸ªæ–¹æ¡ˆè¿›è¡Œä¼˜åŒ–å‘¢ï¼Ÿ
### **RGB æ”¶æ¬¾æ–¹ UTXO çš„ä¼˜åŒ–**
è€ƒè™‘åŸ RGB åè®®ï¼Œä¸ºäº†å®ç°äº¤æ˜“éšç§æ€§ï¼ŒBitcoin ä¸Šå‘èµ·çš„ RGB äº¤æ˜“çš„æ”¶æ¬¾æ–¹ï¼ˆä»¥ä¸€ä¸ª Bitcoin utxo è¡¨è¾¾ï¼‰å’Œè¿™ç¬” Bitcoin äº¤æ˜“çš„ output å¹¶ä¸ä¸€è‡´ã€‚è¿™ä½¿å¾—è§‚å¯Ÿè€…æ— æ³•é€šè¿‡è¿½è¸ª bitcoin äº¤æ˜“çš„æ–¹å¼æ¥è¿½è¸ª RGB äº¤æ˜“ã€‚

ä½†åœ¨ RGB++ åè®®ä¸­ï¼Œæ‰€æœ‰çš„ RGB++ å±‚äº¤æ˜“éƒ½åŒæ„ç»‘å®šå¹¶å…¬ç¤ºåœ¨ CKB ä¸Šï¼Œå°½ç®¡æå¤§åœ°ç®€åŒ–äº†ç”¨æˆ·çš„äº¤æ˜“éªŒè¯éš¾åº¦ï¼Œä¹Ÿè¾ƒä¸ºé—æ†¾åœ°æŸå¤±äº† RGB åè®®çš„éšåŒ¿æ€§ï¼ˆRGB++ åè®®å¯ä»¥åˆ©ç”¨ CKB çš„éšç§å±‚å¼•å…¥[æ›´ä¸ºå¼ºå¤§çš„éšç§å±æ€§](https://forum.grin.mw/t/a-draft-design-of-mimblewimble-on-nervos-ckb/7695)ï¼‰ã€‚æ‰€ä»¥ RGB++ åè®®åœ¨æ”¶æ¬¾äººæ–¹é¢åšäº†è°ƒæ•´ï¼Œå®ƒä¸è¦æ±‚æ”¶æ¬¾æ–¹é¢„å…ˆæä¾›ä¸€ä¸ªè‡ªå·±çš„ UTXOï¼Œè€Œåªéœ€è¦æä¾›ä¸€ä¸ªæ”¶æ¬¾åœ°å€ï¼ŒRGB++ äº¤æ˜“æœ¬èº«åœ¨æ„é€  BTC äº¤æ˜“æ—¶ä¼šç”Ÿæˆä¸€ä¸ª UTXO æŒ‡å‘è¯¥æ”¶æ¬¾äººåœ°å€ã€‚è¿™æ ·å°±å¯ä»¥å®Œæˆéäº¤äº’å¼è½¬è´¦ï¼Œå¤§å¹…ç®€åŒ–äº†ç”¨æˆ·çš„æ“ä½œæµç¨‹ã€‚æ³¨æ„ä¸‹é¢çš„ç¤ºæ„å›¾åšäº†ä¸€äº›ç®€åŒ–ï¼Œä¸ºäº†å®ç°åŒæ„ç»‘å®šï¼ŒæŸäº›åŒ…å«åœ¨ BTC TX å’Œ CKB TX ä¸­çš„å­—æ®µä¸ä¼šè¢«åŒ…å«åœ¨ commitment ä¸­ï¼Œä»¥é˜²æ­¢å‡ºç°äº’ç›¸åŒ…å«çš„çŸ›ç›¾ã€‚

![payee](./assets/sa-payee.png)

### **äº¤æ˜“ä¸²æ¥**
ä¸Šé¢çš„ RGB éäº¤äº’å¼è½¬è´¦çš„ä¼˜åŒ–ä¸ä»…ä»…æœ‰åˆ©äºæå‡ç”¨æˆ·ä½“éªŒï¼Œå¯¹äºäº¤æ˜“ç¡®è®¤çš„ä¼˜åŒ–ä¹Ÿæœ‰æœ¬è´¨çš„ä½œç”¨ã€‚

![sequencing1](./assets/sa-sequencing1.png)

é¦–å…ˆå¯¹äºä¸€ä¸ªè¯šå®çš„ç”¨æˆ·ï¼Œå°½ç®¡åŒºå— reorg ç»å¸¸å‘ç”Ÿï¼Œä½†åªè¦è¯¥ç”¨æˆ·ä¸ä¸»åŠ¨è¿›è¡ŒåŒèŠ±äº¤æ˜“ï¼ŒBTC é“¾ä¸Šæ‰“åŒ…çš„ç”¨æˆ·äº¤æ˜“æ˜¯ä¸å˜çš„ï¼Œå› æ­¤ä¸ä¼šå½±å“åˆ° CKB é“¾ä¸Šçš„ RGB++ èµ„äº§å’ŒçŠ¶æ€ã€‚

è€ƒè™‘ä¸€ç¬” L1 RGB++ äº¤æ˜“ï¼Œå‡è®¾ä¸ºäº†ç”¨æˆ·ä½“éªŒæˆ‘ä»¬å…è®¸å•å— BTC äº¤æ˜“ç¡®è®¤å³å¯å‘èµ·åŒæ„äº¤æ˜“ï¼Œå³åœ¨ CKB æ„é€ åŒæ­¥çš„ RGB++ èµ„äº§äº¤æ˜“ã€‚æ­¤æ—¶ï¼Œå¯¹äºæ¶æ„ç”¨æˆ·ï¼ŒTA å¯èƒ½æ„é€ ä¸€ç¬”æ–°çš„ BTC äº¤æ˜“ï¼Œå–ä»£ä¹‹å‰çš„ BTC TX Bï¼Œä½¿å¾— CKB TX Bâ€˜ æ‰¾ä¸åˆ°å¯¹åº”çš„ BTC äº¤æ˜“ï¼Œä½†è¿™æ—¶ CKB TX Bâ€™ å·²ç»ä¸Šé“¾ã€‚è¿™é‡Œçš„åæœæ˜¯ï¼Œåœ¨ BTC ä¸Šè¢«åŒèŠ±çš„ btc_utxo#2 åœ¨ CKB ä¸Šçš„åŒæ„æ˜ å°„ cell å·²ç»åœ¨ CKB TX Bâ€™ ä¸­æ¶ˆè€—äº†ï¼Œå³ä½¿ç”¨æˆ·åŒèŠ±äº† BTC ä¸Šçš„ utxoï¼Œä»–ä¹Ÿæ— æ³•åŒèŠ± RGB++ çš„èµ„äº§ï¼ŒåŒæ—¶å…ˆå‰äº¤æ˜“ç”Ÿæˆçš„ RGB++ cell è¾“å‡ºï¼ˆ lock ä¸º btc_utxo#3ï¼‰ä¹Ÿå› ä¸ºé“¾å¼äº¤æ˜“çš„å¤±æ•ˆè€Œè¢«æ°¸ä¹…é”å®šã€‚æ‰€ä»¥æ¶æ„ç”¨æˆ·åœ¨ BTC ä¸ŠåšåŒèŠ±äº¤æ˜“ä¸ä¼šæœ‰ä»»ä½•æ”¶ç›Šï¼Œè¿˜ä¼šå¯¼è‡´è‡ªå·±çš„èµ„äº§å¤±æ•ˆã€‚

è€ƒè™‘ä¸€ç¬” L2 RGB++ äº¤æ˜“ï¼Œå®ƒ 100% è¿è¡Œåœ¨ CKB ä¸Šï¼Œå› æ­¤æˆ‘ä»¬åªéœ€è¦ç¬¦åˆåŸæ¥çš„äº¤æ˜“é€»è¾‘å³å¯ï¼Œå³ä¹Ÿå¯ä»¥åœ¨ dapp ä¸­è·å¾—è¿ç»­æ“ä½œçš„ä½“éªŒã€‚

æœ€åè€ƒè™‘ä¸€ç¬” Jump æ“ä½œï¼Œç”¨æˆ·å°† RGB++ èµ„äº§ä»ä¸€ä¸ª Bitcoin UTXO ä¸­è½¬åˆ°ä¸€ä¸ª CKB åœ°å€ä¸Šï¼Œåç»­çš„æ“ä½œä¼šæŒç»­å‘ç”Ÿåœ¨ CKB ä¸Šï¼Œæ­¤æ—¶æˆ‘ä»¬éœ€è¦è€ƒè™‘å›  Bitcoin TX revert é€ æˆçš„ CKB ä¸Šèµ„äº§å¤åˆ¶çš„é—®é¢˜ã€‚

![sequencing2](./assets/sa-sequencing2.png)

è€ƒè™‘ä¸Šé¢çš„äº¤æ˜“ï¼ŒBTC_TX_A å’Œ CKB_TX_B åŒæ„ç»‘å®šï¼Œä¹‹å BTC_TX_A è¢«é‡æ„æˆ BTC_TX_Aâ€™ï¼Œæ­¤æ—¶åŒæ„ç»‘å®šçš„äº¤æ˜“ CKB_TX_Bâ€™ æ— æ³•é€šè¿‡ ckb å…±è¯†ä¸Šé“¾ï¼Œå› ä¸ºå®ƒä¾èµ–çš„ input (lock= btc_utxo#1)å·²ç»åœ¨ CKB_TX_B ä¸­è¢«ä½¿ç”¨äº†ã€‚è¿™å°±å¯¼è‡´ BTC ä¸Šçš„äº¤æ˜“å’Œ CKB çš„äº¤æ˜“åŒæ„ç»‘å®šå¤±è´¥ã€‚ä½†æ³¨æ„ï¼Œå¦‚æœåŒæ„ç»‘å®šå¤±è´¥ï¼Œä½†ç›¸å…³çš„æ‰€æœ‰èµ„äº§å‡è¢«é”å®šï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸è®¤ä¸ºå‡ºç°äº†å®‰å…¨æ€§é—®é¢˜ã€‚å› ä¸ºè¿™ç§å¤±è´¥æºè‡ªäº¤æ˜“å‘èµ·äººä¸»è§‚æ”»å‡»åè®®ï¼Œé‚£ä¹ˆTAçš„æ‰€æœ‰èµ„äº§è¢«æ°¸ä¹…é”å®šä¸æ˜¯é—®é¢˜ã€‚

ä½†å›¾ç¤ºçš„æ“ä½œä¸­ï¼Œæˆ‘ä»¬å‘ç° CKB ä¸Šçš„ä¸¤ä¸ªè¾“å‡ºï¼ŒRGB++ cell çš„ lock æ˜¯ btc_utxo#2ï¼Œå®ƒä¾èµ–è¢« revert çš„æ—§çš„ BTC äº¤æ˜“ï¼Œå› æ­¤è¢«æ°¸ä¹…é”å®šï¼Œæ²¡é—®é¢˜ã€‚å•å¦ä¸€ä¸ª ckb cell åˆ™ä¸å—å½±å“ã€‚è¿™å°±é€ æˆäº†å®‰å…¨é£é™©ã€‚

å› æ­¤ï¼Œæˆ‘ä»¬å¼•å…¥ä¸€ä¸ªæ–°çš„ lockï¼Œæš‚å®šåä¸º btc_time_lock é€šè¿‡æä¾›é¢å¤–çš„é”å®šé€»è¾‘æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

### **BTC Time Lock**
btc_time_lock çš„æ ¸å¿ƒå‚æ•°æœ‰ä¸‰ä¸ªï¼Œåˆ†åˆ«æ˜¯ lock_hashï¼Œafterï¼Œå’Œ bitcoin_txã€‚å®ƒå…·ä½“çš„å«æ„æ˜¯ï¼šâ€œä»…å½“åœ¨å‚æ•°ä¸­æŒ‡å®šçš„ bitcoin_tx è¢«è¶…è¿‡ after ä¸ª btc åŒºå—ç¡®è®¤åï¼Œæœ¬ cell æ‰å¯ä»¥è¢«è§£é”ï¼Œä¸”è§£é”åéœ€è¦æ¢æˆ lock_hash æŒ‡å®šçš„ lockscript(ckb åœ°å€)â€ã€‚ æˆ‘ä»¬ä»¥ä¸Šé¢çš„ä¾‹å­çœ‹ä¸€ä¸‹ btc_time_lock æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚

![time lock](./assets/sa-time-lock.png)

å’Œä¹‹å‰çš„è®¨è®ºç›¸åŒï¼Œå¦‚æœ BTC_TX_A è¢« revert äº†ï¼Œå¯¹åº”çš„ RGB++ Cell è¢«æ°¸ä¹…é”å®šï¼Œè€Œå…¶ä»–çš„ CKB cell åˆ™æŒ‰ç…§è¦æ±‚è¢«æ”¾ç½®åœ¨ btc_time_lock ä¸­ï¼Œä¸”ä»–ä»¬è¢«è§£é”çš„æ¡ä»¶æ˜¯ BTC_TX_A ç»è¿‡äº† 6 ä¸ªåŒºå—ç¡®è®¤ã€‚é‚£ä¹ˆæ˜¾ç„¶ç”±äº BTC_TX_A ä¸å­˜åœ¨è€Œå› æ­¤è¢«æ°¸ä¹…é”å®šã€‚åè¿‡æ¥è®²ï¼Œå¦‚æœ 6 ä¸ª btc ç¡®è®¤åï¼ŒBTC_TX_A ä»ç„¶å­˜åœ¨ï¼Œé‚£ä¹ˆè¯¥ CKB Cell å°±å¯ä»¥æ­£å¸¸ä½¿ç”¨ã€‚

## **æ€»ç»“**
æ€»ç»“æ¥è¯´ï¼ŒRGB++ ä¸è®ºåœ¨ L1 è¿˜æ˜¯åœ¨ L2 ä¸Šéƒ½å¯ä»¥è·å¾—ä¸ Bitcoin ç›¸åŒçº§åˆ«çš„å®‰å…¨æ€§ï¼Œåœ¨ L1 å’Œ L2 Jump æ—¶ï¼ŒRGB++ åè®®é¢å¤–è¦æ±‚èµ„äº§é”å®š 6 ä¸ªæˆ–æ›´å¤šçš„ BTC åŒºå—ï¼Œä»¥è·å¾—åœ¨è·¨å±‚ä½¿ç”¨æ—¶ä¸€è‡´çš„å®‰å…¨æ€§ã€‚RGB++ åè®®åœ¨ä¸å¦¥åå®‰å…¨æ€§çš„å‰æä¸‹ä¸º BTC ç½‘ç»œè¿›è¡Œäº†å›¾çµå®Œå¤‡çš„è¡¥å……å’Œæ€§èƒ½çš„æ‰©å±•ã€‚

## References
[RGB++ æ·±å…¥è®¨è®º(1): å®‰å…¨æ€§åˆ†æ](https://talk.nervos.org/t/rgb-1/7798)  
[ç›´æ’­å›é¡¾ï½œRGB++ çš„å‰ä¸–ä»Šç”Ÿ](https://talk.nervos.org/t/rgb/7817)

================================================
File: docs/security-analysis-en.md
================================================
# A Deep Dive into RGB++: Security Analysis 

*Cipher from CELL Studio & Nervos Foundation*

> Special thanks to [Ren Zhang](https://scholar.google.com/citations?hl=en&user=JB1uRvQAAAAJ), [Ian](https://github.com/doitian), and [c4605](https://talk.nervos.org/u/c4605/summary) for feedback and discussion.
> The RGB receiver optimization approach is inspired by [Jason Cai](https://twitter.com/CryptoStwith).

## **PoW is More Secure Than You Think**
The security concern in Proof-of-Work (PoW) lies in block revert/reorg which can enable double-spending attacks. Consider a network with an honest miner, a userâ€™s status and assets would remain accurate, then only the block reorganization there could cause losses from double-spending. Consequently, the core security assumption of PoW is that transactions are highly unlikely to be reverted after N blocks. In Bitcoinâ€™s case, 6 or fewer blocks are typically considered secure enough against double-spends.

Obviously, Bitcoin transactions with 6 confirmations are more secure than 1 confirmation. So is there a linear relationship between the number of PoW confirmations and security? No, **the difficulty of overturning a block increases exponentially as the depth of the block increases**. The precise parameters of this exponential security growth have been analyzed in dozens of research papers. What has become clear is that â€œN confirmationsâ€ provide greater security than previously thought.

According to calculations by Dr. [Ren Zhang](https://scholar.google.com/citations?hl=en&user=JB1uRvQAAAAJ), assuming that the adversaryâ€™s Hash rate accounts for 30%, CKB would need to maintain a 2.5% orphan block rate and require 23.29 confirmations to match the security of 6 confirmations on Bitcoin with a 0% orphan rate. This equivalence relationship provides a convenient way to discuss the security of various typical operations in the RGB++ protocol.

![pow](./assets/sa-pow.png)
***Schematic diagram of PoW security (non-theoretical calculation)***

## **Security of RGB**
RGB binds the status and contracts of RGB to Bitcoin UTXO using single use seals and client-side validation methods. This provides an extension of Turing-complete scalability for Bitcoin. There are two types of transaction security: 1) Correctness of state calculations, 2) Transaction certainty. Client-side validation ensures the correctness of state calculations. Everyone is responsible for their own state and does not rely on any third party. Single-use seals based on BTC UTXO ensure that the difficulty of double spending on RGB matches that of double spending on Bitcoin. Therefore, we can say that **RGB inherits 100% of Bitcoinâ€™s security**. Users can achieve their desired security threshold by waiting for the corresponding number of Bitcoin confirmations.

## **Security of RGB++ Protocol**
### **L1 Transaction Security**
L1 transactions for RGB++ refer to that the â€œholderâ€ of UTXOs for RGB++ transactions is the holder of Bitcoinâ€™s UTXOs. That is, only consuming Bitcoin UTXO can operate or update RGB++ UTXO. In this model, although each RGB++ transaction initiates a parallel CKB transaction, its security does not rely on CKB. CKB is only utilized for data availability and status disclosure purposes. Therefore, the L1 transaction security of RGB++, identical to RGB protocol, fully inherits the security of Bitcoin.

### **L2 Transaction Security**
L2 transactions occur 100% on CKB, meaning CKB is responsible for 100% of L2 security. However,due to the non-linear security scaling of PoW chains previously mentioned, 24 block CKB confirmations provide equivalent security to 6 confirmed Bitcoin transactions. Therefore, we could believe that L2 transaction security matches L1 transaction security(more block confirmations needed but cost shorter time for the actual confirmation).

The prerequisite for realizing this equivalent security is that the RGB++ isomorphic mapping chain must be PoW. If it were a PoS chain, its security upper bound would be limited by the staking amount of PoS no matter the number of confirmed blocks, which cannot compare to Bitcoinâ€™s security.

### **Jump Operation**
The RGB++ protocol enables users to seamlessly transfer their assets between Bitcoin and CKB in either direction at any time. There is no need for a cross-chain bridge during the switching process, and any reliance on multi-signature parties. This transition of assets or state between chains is called a Jump operation.

Before and after the Jump operation, the core points that affect the security of the RBG++ protocol are:

Single-use seals, from using Bitcoin UTXO to using CKB UTXO, or vice versa;
Unchanged client verification data on CKB as they are the isomorphic binding transactions on CKB.
During a Jump, users need to wait for sufficient block confirmations on both Bitcoin and CKB to to ensure the security.

### **Optimization of RGB Payee UTXO**
Considering the original RGB protocol, in order to achieve transaction privacy, the payee of the RGB transaction initiated on Bitcoin (i.e. Bitcoin UTXO) is not consistent with the output of theBitcoin transaction. This makes it impossible for observers to track RGB transactions similarly to Bitcoin transactions.

In contrast, in the RGB++ protocol, all transactions on RGB++ layer are isomorphically bound and published on CKB. Although it greatly simplifies user transaction verification, it, regrettably, compromises the anonymity of the orginal RGB protocol (the RGB++ protocol can leverage the privacy layer on CKB for [more powerful privacy attributes](https://forum.grin.mw/t/a-draft-design-of-mimblewimble-on-nervos-ckb/7695)). To address this, RGB++ adjusts the payeeâ€™s role, eliminating the need for the payee to provide their UTXO in advance. Only a payment address is required, as the RGB++ transaction will generate a UTXO pointing to the payee during a BTC transaction. In this way, non-interactive transfers can be completed, greatly simplifying the userâ€™s operation process. Please Note that certain simplifications are made in the diagram below: to achieve isomorphic binding, some fields present in BTC and CKB transactions are excluded from commitment to prevent mutual inclusion conflicts.

![payee](./assets/sa-payee.png)

### **Transaction Sequencing**
As outlined above, the optimization of RGB non-interactive transfers, serves a dual purpose by significantly enhancing user experience and playing a pivotal role in the optimization of transaction confirmations.

![sequencing1](./assets/sa-sequencing1.png)

First, for an honest user, block reorgs on the BTC chain often occur but do not affect the validity of their transactions or associated RGB++ assets and status on the CKB chain, as long as they do not intentionally initiate double spending.

Consider an L1 RGB++ transaction, for better user experience, we allow a single block of BTC transactions to be confirmed to initiate isomorphic transactions, that is, construct a synchronized RGB++ asset transaction on CKB. At this point, a malicious user could construct a new BTC transaction to replace a previous BTC TX B, which means that CKB TX Bâ€™ cannot find the corresponding BTC transaction. However, the new CKB TX Bâ€™ has already been committed to the CKB chain. As a result, the isomorphic mapping cell on CKB of btc_utxo#2 which was double spent on BTC has been consumed in CKB TX Bâ€™. Even if the malicious user successfully double-spend utxo on BTC, he cannot double-spend the corresponding assets on RGB++. At the same time, the RGB++ cell output generated by the previous transaction (lock is btc_utxo#3) is also locked due to the failure of the chain transaction. In summary, malicious users cannot benefit from BTC double-spends and will cause their own RGB++ assets to become unusable.

For an L2 RGB++ transaction which runs 100% on CKB, we only need to comply with the original transaction logic. In other words, we can have a continuous experience within the dApp.

Finally, consider a â€œJumpâ€ operation where a user transfers RGB++ assets from a Bitcoin UTXO to a CKB address and subsequent operations continue on CKB. In this case, we need to consider the problem of asset duplication on CKB caused by Bitcoin TX revert.

![sequencing2](./assets/sa-sequencing2.png)

Taking the above transaction, where BTC_TX_A on Bitcoin is isomorphically bound to CKB_TX_B on Nervos CKB, as an example. If BTC_TX_A gets reorganized as BTC_TX_Aâ€™, the isomorphic transaction CKB_TX_Bâ€™ cannot be validated through the CKB consensus, as it relies on the input (lock = btc_utxo#1), which has already been utilized in CKB_TX_B. Consequently, the isomorphic binding of transactions on BTC and CKB fails. Please note that if isomorphic binding fails while all related assets are locked, we do not consider it a security issue. This failure results from transaction initiatorâ€™s intentionally attacks, it should not be a problem that all his assets are permanently locked.

But as shown in the above figure, there are two outputs on CKB. The lock on the RGB++ cell is btc_utxo#2. Since it depends on the old BTC transaction that has been reverted, there is no issue with it being permanently locked. However, the other CKB cell remains unaffected, which brings a security risk.

Therefore, we introduce a new lock, tentatively named btc_time_lock, aiming to mitigate the issue by incorporating additional locking logic.

### **BTC Time Lock**
There are three core parameters of btc_time_lock: lock_hashï¼Œafterï¼Œå’Œ bitcoin_tx. Its specific meaning is: â€œOnly when the bitcoin_tx specified in the parameter is confirmed by more than after btc blocks, this cell can then be unlocked. After unlocking, it needs to be replaced with the lock script (CKB address) specified by lock_hash.â€ Letâ€™s use the above example to see how btc_time_lock works.

![time lock](./assets/sa-time-lock.png)

Same as the previous discussion, if BTC_TX_A is reverted, the corresponding RGB++ Cell will be permanently locked. The other CKB Cell is placed in btc_time_lock as required, with the condition for their unlock being the confirmation of BTC_TX_A by 6 blocks. Then, apparently, BTC_TX_A is permanently locked since it does not exist. On the other hand, if BTC_TX_A still exists after the confirmation from six BTC blocks, then the CKB Cell can function normally.

## **Summary**
In summary, the RGB++ protocol provide a level of security equivalent to Bitcoin, whether having jump operations on Layer 1 or Layer 2. Jump between L1 and L2 requires the additional step of locking assets for six or more BTC blocks, ensuring consistent security approach when across layers. The RGB++ protocol complements the BTC network by providing Turing-complete functionality and enhanced performance without compromising security.

## References
[A Deep Dive into RGB++: Security Analysis](https://talk.nervos.org/t/a-deep-dive-into-rgb-security-analysis-translation/7816)

